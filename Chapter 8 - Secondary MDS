---
title: "PARPi version 2"
author: "Luke Steventon"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(broom)
library(ggplot2)
library(skimr)
library(survminer)
library(survival)
library(rbin) 
library(readr)
library(here)
library(knitr)
library(gtsummary)
setwd("K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Thesis Chapters\\Chapter 8 - Secondary MDS")
getwd()
```

Read in the datasets produced from linkage of NCRD and SACT.
The HES dataset produced from linking all APC and OPC data will be used to identify secondary diagnoses of MDS/AML for this study.
```{r cars}
#This table contains the NCRAS records for all gynae patients
ovariancohort<-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Thesis Chapters\\Chapter 4 - Data Linkage\\ovarian_cohort20NOV.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)

#This table contains surgical information
treatments<-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Thesis Chapters\\Chapter 4 - Data Linkage\\ODR1920_080_AV_Treatment_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)
```

n=23,774 ovarian cancer patients are represented in the NCRAS registry.
n=1,697 received PARPi
```{r}
ovariancohort %>% 
  count(PSEUDO_PAT) #n=23,774 ovarian/FT/PP patients

ovariancohort %>% 
   ungroup() %>% 
   filter(str_detect(DRUG_GROUP, "NIRAPARIB|OLAPARIB|RUCAPARIB")) %>% 
   count(PSEUDO_PAT)#n=1,697 received PARP
```


n=23,774 before this exclusion.
1a: Exclude patients listed as stage I, or IIA, or unknown. 
n=16,524 after this step
```{r}
ovariancohort %>% count(PSEUDO_PAT)#N=23,774

ovariancohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(is.na(STAGE_BEST_CLEAN)|STAGE_BEST_CLEAN=="Unknown") %>%  
  count(STAGE_BEST_CLEAN)#N=4,188 with missing stage data

ovariancohort %>% 
  ungroup() %>%
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(!str_detect(STAGE_BEST_CLEAN,"0|1A|1a|1b|1c|1A|1B|1C|1a|2A|2a|2B|2b|2c|2C|IIb|IIB|iib|iiB|IIc|IIC|iic|iiC|IC")) %>% 
  filter(STAGE_BEST_CLEAN!="1") %>% 
  filter(STAGE_BEST_CLEAN!="2") %>%
  filter(STAGE_BEST_CLEAN!="6") #N=15,940 with exclusionary stage listed (not including missing data)

#We will add a flag for patients who received a parp but have missing stage info. If they received a PARP, they are advanced-stage disease as they can only be accessed in advanced patients.
ovariancohort<-ovariancohort %>% 
  ungroup() %>% 
  mutate(parpstageflag=ifelse(str_detect(DRUG_GROUP, "PARIB|BEVACIZUMAB"),1,NA))%>%
  group_by(PSEUDO_PAT) %>%
  fill(parpstageflag, .direction ="updown")

ovariancohort %>%
ungroup() %>%
filter(is.na(STAGE_BEST_CLEAN)&parpstageflag==1)  %>%
count(PSEUDO_PAT)#n=521 patients who have missing stage data but received PARP or BEV and are therefore advanced stage

ovariancohort<-ovariancohort %>%
  mutate(STAGE_BEST_CLEAN=ifelse(parpstageflag==1&is.na(STAGE_BEST_CLEAN), "Advanced unspecified",STAGE_BEST_CLEAN))
  
ovariancohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(STAGE_BEST_CLEAN)

ovariancohort<-ovariancohort %>% 
  ungroup() %>% 
  filter(!str_detect(STAGE_BEST_CLEAN,"0|1A|1a|1b|1c|1A|1B|1C|1a|2A|2a|2B|2b|2c|2C|IIb|IIB|iib|iiB|IIc|IIC|iic|iiC|IC")) %>%     filter(STAGE_BEST_CLEAN!="1") %>% 
  filter(STAGE_BEST_CLEAN!="2") %>%
  filter(STAGE_BEST_CLEAN!="6") %>% 
  filter(!is.na(STAGE_BEST_CLEAN)) 

ovariancohort %>% 
  ungroup() %>% 
  count(PSEUDO_PAT) #n=16,524

ovariancohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(STAGE_BEST_CLEAN) 

#3	1813			
#3A	859			
#3B	941			
#3C	6783			
#4	3895			
#4A	666			
#4B	1043			
#4C	3			
#Advanced unspecified	521
```
Exclusion: treatment within 90 days of diagnosis. 
n=16,524 before
n=12,875 after
```{r}
ovariancohort %>% count(PSEUDO_PAT) #n=16,524

ovariancohort<-ovariancohort %>%
  group_by(PSEUDO_PAT) %>% 
  mutate(DIAGNOSISDATEBEST=dmy(DIAGNOSISDATEBEST)) %>% 
  mutate(ADMINISTRATION_DATE=as.Date(ADMINISTRATION_DATE)) %>% 
  mutate(diagnosistotreat=as.numeric(difftime(min(ADMINISTRATION_DATE),DIAGNOSISDATEBEST,units="days")))

ovariancohort<-ovariancohort %>%
 filter(diagnosistotreat<91)

ovariancohort %>% count(PSEUDO_PAT) #n=12,875
```

Create a bevacizumab flag. This will used to identify patients who received PARP+bevacizumab, as per the PAOLA trial. This can be used to compare incidence to the RCT:
```{r}
ovariancohort %>% 
  count(PSEUDO_PAT) #N=12,875

ovariancohort<-ovariancohort %>% 
  mutate(bevacizumabflag=ifelse(str_detect(DRUG_GROUP, "BEVACIZUMAB"), 1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(bevacizumabflag, .direction = "updown")

ovariancohort %>% 
  count(PSEUDO_PAT) #N=12,875

beva_table<-ovariancohort %>% 
   distinct(PSEUDO_PAT,.keep_all=T) %>% 
   select(PSEUDO_PAT,bevacizumabflag)

beva_table %>% 
  write_csv("beva_flag_table.csv") 
```

```{r}
ovariancohort<-ovariancohort %>% 
   mutate(parpflag=ifelse(str_detect(DRUG_GROUP, "NIRAPARIB|OLAPARIB|RUCAPARIB"),1,NA)) %>%
   mutate(olaparibflag=ifelse(str_detect(DRUG_GROUP, "OLAPARIB"),1,NA)) %>%      
   mutate(niraparibflag=ifelse(str_detect(DRUG_GROUP, "NIRAPARIB"),1,NA)) %>%  
   mutate(rucaparibflag=ifelse(str_detect(DRUG_GROUP, "RUCAPARIB"),1,NA)) %>% 
   group_by(PSEUDO_PAT) %>% 
   fill(parpflag, .direction ="updown") %>% 
   fill(olaparibflag, .direction ="updown") %>% 
   fill(niraparibflag, .direction ="updown") %>% 
   fill(rucaparibflag, .direction ="updown") %>% 
   ungroup()
```


n=12,875 before this exclusion.
1c: Exclusion remove drugs of non-interest: 
n=12,806 after exclusion
```{r}
ovariancohort %>% 
  count(PSEUDO_PAT) #n=12,875

ovariancohort<-ovariancohort %>% 
  filter(str_detect(DRUG_GROUP,"CARBOPLATIN|CISPLATIN|PACLITAXEL|OLAPARIB|NIRAPARIB|RUCAPARIB|DOXORU|GEMCITABINE|LIPOSO")) %>% 
    filter(DRUG_GROUP!="STEROID") %>%
    filter(DRUG_GROUP!="NOT MATCHED") %>%
    filter(DRUG_GROUP!="NOT CHEMO") %>%
    filter(DRUG_GROUP!="DEXAMETHASONE") %>%
    filter(DRUG_GROUP!="FLUCONAZOLE") %>% 
    filter(DRUG_GROUP!="HYDROCORTISONE")

ovariancohort %>% 
  count(PSEUDO_PAT) #12,806
```

n=12,806 patients before this exclusion
2a: If patient was treated before 2014, remove them as this interferes with the labeling of lines of therapy. They may also have 2nd line treatment recorded as their first SACT and therefore difficulty in labelling.
N=10,970 after this exclusion.
```{r}
ovariancohort %>% 
  count(PSEUDO_PAT) #n=12,806 patients

ovariancohort<-ovariancohort %>% 
  mutate(ADMINISTRATION_DATE=as.Date(ADMINISTRATION_DATE)) %>% 
  mutate(studyperiodexclusion=ifelse(ADMINISTRATION_DATE<"2014-01-01",1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(studyperiodexclusion, .direction="updown") %>% 
  filter(is.na(studyperiodexclusion))

ovariancohort %>% 
  count(PSEUDO_PAT) #n=10,970 patients
```

n= 10,970 before
2b: Define lines of therapy. Start with line=1 and flag as new regimen when days between SACT is 120 days or more.
n= 12,246 after
No exclusions
```{r}
ovariancohort %>% 
  count(PSEUDO_PAT) #n=10,970 patients

ovariancohort<-ovariancohort %>% 
  group_by(PSEUDO_PAT) %>% 
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
  distinct(PSEUDO_PAT, ADMINISTRATION_DATE, DRUG_GROUP,.keep_all=T) %>% 
  mutate(DAYSFROMPREVIOUSADMIN=difftime(ADMINISTRATION_DATE, lag(ADMINISTRATION_DATE), units = "days")) %>% 
  mutate(lineoftherapy=row_number()) %>% 
  mutate(lineoftherapy=ifelse(lineoftherapy!=1,NA,lineoftherapy))
  
#Define lines of therapy as per 120 day rule:
linesoftherapy<-ovariancohort %>% 
  filter(DAYSFROMPREVIOUSADMIN>119) %>% 
  arrange(PSEUDO_PAT,ADMINISTRATION_DATE) %>% 
  distinct(PSEUDO_PAT, ADMINISTRATION_DATE,lineoftherapy,.keep_all=T) %>%
  select(PSEUDO_PAT, ADMINISTRATION_DATE,lineoftherapy, DAYSFROMPREVIOUSADMIN)%>% 
  mutate(lineoftherapy=row_number()) %>% 
  mutate(lineoftherapy=lineoftherapy+1) %>% 
  mutate(ADMINISTRATION_DATE=as.Date(ADMINISTRATION_DATE))

#Rejoin lines of therapy table to main table:
ovariancohort<-ovariancohort %>% 
  left_join(linesoftherapy, by = c("PSEUDO_PAT", "ADMINISTRATION_DATE")) %>% 
  select(-lineoftherapy.x, -DAYSFROMPREVIOUSADMIN.x) %>% 
  rename(lineoftherapy=lineoftherapy.y) %>%
  rename(DAYSFROMPREVIOUSADMIN=DAYSFROMPREVIOUSADMIN.y) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(lineoftherapy,.direction = "down") %>% 
  mutate(lineoftherapy=ifelse(is.na(lineoftherapy),1,lineoftherapy)) %>% 
  ungroup()

ovariancohort %>% 
  count(PSEUDO_PAT) #n=10,970 patients
```


n=10,970 before
2d: Exclude patients who have a record of SACT AFTER death:
This is a data error and patients with this error should not be included.
n=0 excluded 
n=10,970 after
```{r}
ovariancohort %>% 
  count(PSEUDO_PAT) #n=10,970 patients

ovariancohort<-ovariancohort %>%
  mutate(VITALSTATUSDATE=dmy(VITALSTATUSDATE)) %>% 
  select(ADMINISTRATION_DATE,VITALSTATUSDATE,VITALSTATUS,PSEUDO_PAT) %>% 
   mutate(exclude=ifelse(ADMINISTRATION_DATE>VITALSTATUSDATE&VITALSTATUS=="D",1,NA))%>%
   group_by(PSEUDO_PAT) %>% 
  fill(exclude, .direction="updown") %>% 
   distinct(PSEUDO_PAT,.keep_all=T)%>%
   select(PSEUDO_PAT, exclude)%>% 
   filter(is.na(exclude)) %>% 
   right_join(ovariancohort, by = "PSEUDO_PAT") %>%
   filter(is.na(exclude))

ovariancohort %>%
count(PSEUDO_PAT) #n=10,970
```

3a: Flag patients who received PARPi:
```{r}
ovariancohort %>% 
  count(PSEUDO_PAT) #n=10,970  patients

ovariancohort %>% 
  ungroup() %>% 
  filter(str_detect(DRUG_GROUP, "NIRAPARIB|OLAPARIB|RUCAPARIB")) %>% 
count(PSEUDO_PAT)

#Create a flag for those who have received PARPi:
ovariancohort<-ovariancohort %>% 
   mutate(parpflag=ifelse(str_detect(DRUG_GROUP, "NIRAPARIB|OLAPARIB|RUCAPARIB"),1,NA)) %>%
   mutate(olaparibflag=ifelse(str_detect(DRUG_GROUP, "OLAPARIB"),1,NA)) %>%      
   mutate(niraparibflag=ifelse(str_detect(DRUG_GROUP, "NIRAPARIB"),1,NA)) %>%  
   mutate(rucaparibflag=ifelse(str_detect(DRUG_GROUP, "RUCAPARIB"),1,NA)) %>% 
   group_by(PSEUDO_PAT) %>% 
   fill(parpflag, .direction ="updown") %>% 
   fill(olaparibflag, .direction ="updown") %>% 
   fill(niraparibflag, .direction ="updown") %>% 
   fill(rucaparibflag, .direction ="updown") %>% 
   ungroup()

#Create separate table for therapy flags
parp_table<-ovariancohort %>% 
   mutate(parpflag=ifelse(str_detect(DRUG_GROUP, "NIRAPARIB|OLAPARIB|RUCAPARIB"),1,NA)) %>%
   mutate(olaparibflag=ifelse(str_detect(DRUG_GROUP, "OLAPARIB"),1,NA)) %>%      
   mutate(niraparibflag=ifelse(str_detect(DRUG_GROUP, "NIRAPARIB"),1,NA)) %>%  
   mutate(rucaparibflag=ifelse(str_detect(DRUG_GROUP, "RUCAPARIB"),1,NA)) %>% 
   group_by(PSEUDO_PAT) %>% 
   fill(parpflag, .direction ="updown") %>% 
   fill(olaparibflag, .direction ="updown") %>% 
   fill(niraparibflag, .direction ="updown") %>% 
   fill(rucaparibflag, .direction ="updown") %>% 
   ungroup() %>% 
   select(PSEUDO_PAT,parpflag,olaparibflag,niraparibflag,rucaparibflag, lineoftherapy) %>% 
   distinct(PSEUDO_PAT,.keep_all=T)

ovariancohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(parpflag) #n=1,187 parp patients, 9,783 chemotherapy alone

#Count numbers of PARPi patients
ovariancohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(olaparibflag) #n=257 patients

ovariancohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(niraparibflag) #n=892 patients

ovariancohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(rucaparibflag) #n=46 patients
```

EJC COMMENT: Perform analysis in recurrent setting only: this involves filtering patients who received PARPi only in 1st line:
```{r}
ovariancohort %>% 
  count(PSEUDO_PAT)#n=10,970

#Isolate patients who had PARP in 2nd line
parpcohort<-ovariancohort %>% 
group_by(PSEUDO_PAT) %>% 
  #mutate(chemonly=ifelse(str_detect(DRUG_GROUP,"ARIB"),1,NA)) %>% 
 # fill(chemonly,.direction="updown") %>% select(chemonly) %>% filter(is.na(chemonly))
  mutate(filter=ifelse(str_detect(DRUG_GROUP,"ARIB")&lineoftherapy>1,1,NA))%>% 
  fill(filter,.direction="updown") %>% 
  ungroup() %>% 
  filter(filter==1) %>% 
  select(-filter)#Removes patients who only received PARP in first line. The flags for previous treatment should remain in there for future reference.

parpcohort %>% 
  count(PSEUDO_PAT)#n=1,157 who had second line PARPi therapy

#Create flag for chemo only
chemo_only<-ovariancohort %>% 
group_by(PSEUDO_PAT) %>% 
  mutate(chemo_only=ifelse(str_detect(DRUG_GROUP,"ARIB"),1,NA)) %>% 
  fill(chemo_only,.direction="updown") %>% 
  filter(is.na(chemo_only)) %>% 
  ungroup() %>% 
  select(-chemo_only)

chemo_only %>% 
  count(PSEUDO_PAT) #n=9,873 who had chemo only


#Join parp table to main cohort to remove patients who only had PARPi in 1st line
ovariancohort<-rbind(parpcohort, chemo_only)


ovariancohort %>% 
  count(PSEUDO_PAT) #n=10,940 who received PARP in 2nd line or chemotherapy only
```



3b: Label the start of PARPi therapy for each patient. This is different to the index date of 8 weeks post-chemo!! 
```{r}
ovariancohort %>% 
  count(PSEUDO_PAT) #N=10,940

ovariancohort<-ovariancohort %>% 
  mutate(parpstartdate=as.Date(ifelse(str_detect(DRUG_GROUP, "NIRAPARIB|OLAPARIB|RUCAPARIB"), ADMINISTRATION_DATE, NA))) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(parpstartdate,.direction = "updown") %>% 
  mutate(parpstartdate=min(parpstartdate)) %>% 
  ungroup()
```

3c: Calculate total time on PARPi therapy:
```{r}
ovariancohort %>% count(PSEUDO_PAT) #N=10,940

 ovariancohortparp <- ovariancohort %>%
  filter(str_detect(DRUG_GROUP, "NIRAPARIB|OLAPARIB|RUCAPARIB")) %>%
  group_by(PSEUDO_PAT, lineoftherapy) %>% 
  mutate(parpperiod=as.numeric(difftime(max(ADMINISTRATION_DATE), min(ADMINISTRATION_DATE), units = "days"))) %>% 
  mutate(parpperiod=parpperiod+28) #Add 28 days on to account for the length of the final cycle
 
 ovariancohortparp %>%
   arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
   select(DRUG_GROUP, ADMINISTRATION_DATE,lineoftherapy, parpperiod)

ovariancohortparp<-ovariancohortparp %>%  #Calculate the total time by adding the period of each cycle. Shouldn't change as PARP should only be given in one setting?
  group_by(PSEUDO_PAT) %>% 
  distinct(PSEUDO_PAT, parpperiod,.keep_all=T) %>% 
  mutate(totalparptime=sum(parpperiod)) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>%
  select(PSEUDO_PAT, totalparptime,lineoftherapy) %>% 
  left_join(ovariancohort, by = c("PSEUDO_PAT", "lineoftherapy"))

ovariancohort<-ovariancohortparp %>% 
  select(PSEUDO_PAT, totalparptime, parpstartdate) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  right_join(ovariancohort, by = "PSEUDO_PAT")

ovariancohort %>% count(PSEUDO_PAT) #N=10,940 - this confirms no patients were excluded

ovariancohort %>%
   ungroup() %>% 
   count(totalparptime)

#Treatment cap is 2 years for olaparib, 3 years for niraparib as perP DiSilvestro et al (overall survival with maintenance olaparib at a 7-year follow-up.....)

ovariancohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  select(totalparptime) %>% 
  summary()
```
FOR PAPER: PLOT TIME ON PARP:
```{r}
hist(ovariancohort$totalparptime)
```



3d: Calculate number of prior lines of therapy before PARPi
```{r}
ovariancohort %>% count(PSEUDO_PAT) #N=10,940 

ovariancohort<-ovariancohort %>% 
  filter(str_detect(DRUG_GROUP, "NIRAPARIB|OLAPARIB|RUCAPARIB")) %>%
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  mutate(linesbeforePARP=lineoftherapy-1) %>% 
  select(PSEUDO_PAT, linesbeforePARP) %>% 
  right_join(ovariancohort, by = "PSEUDO_PAT") #MAY NEED TO BE CHANGED TO LEFT JOIN IF LOSING PATIENTS

ovariancohort %>% count(PSEUDO_PAT) #N=10,940 CHECK THAT NO PATIENTS WERE EXCLUDED HERE - otherwise the code is wrong
ovariancohort %>%
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(linesbeforePARP)

#firstline: n=2
#2nd line: n=940
#3: n=171
#4: n=41
#5; n=3
```

3e: Label as recurrent or front-line
```{r}
ovariancohort<-ovariancohort %>% 
  mutate(frontline=ifelse(linesbeforePARP<2,1,NA)) %>% 
  mutate(recurrent=ifelse(linesbeforePARP>1,1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(frontline, .direction="updown") %>% 
  fill(recurrent, .direction="updown") %>% 
  ungroup()
```

Write intermediate dataframe:
```{r}
ovariancohort3<-ovariancohort %>% 
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE)

ovariancohort3 %>% 
  ungroup() %>% 
  skimr::skim()

ovariancohort3%>% 
  write.csv("ovariancohortintermediate.csv")
```

Read intermediate files to save time:
```{r}
ovariancohort<-read_csv(
  "ovariancohortintermediate.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)
```

3f: Label concomitant bevacizumab given with PARP inhibitor. This will allow comparison with the PAOLA trial, olaparib + beva in front-line.
```{r}
ovariancohort<-ovariancohort %>% 
  group_by(PSEUDO_PAT, lineoftherapy) %>% 
  mutate(bevacizumabflag=ifelse(str_detect(DRUG_GROUP, "BEVACIZUMAB"),1,NA)) %>% 
  fill(bevacizumabflag,.direction = "updown") %>% 
  mutate(bevacizumabwithparp=ifelse(str_detect(DRUG_GROUP, "OLAPARIB|NIRAPARIB|RUCAPARIB")& bevacizumabflag==1, 1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(bevacizumabwithparp, .direction = "updown") %>% 
  ungroup()
```

#####################
#######################
The next steps involve identifying MDS and AML in the HES datasets which have previously been produced.

4: Select PARPi patients in the NCRD dataset. Perform a count of how many patients treated with PARPi appear in the HES data.
```{r}
NCRD_secondaryMDSAML<-read_csv(
  "ODR1920_080_AV_Tumour_2019Data_v2.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL) 

filter2<-ovariancohort %>% 
  distinct(PSEUDO_PAT)

NCRD_MDS<-filter2 %>% 
  merge(NCRD_secondaryMDSAML, by = "PSEUDO_PAT")

NCRD_MDS %>% 
  count(PSEUDO_PAT)#n=all 10,940 patients link to the NCRD data
  
NCRD_MDS<-NCRD_MDS %>% 
  mutate(MDSAML=ifelse(str_detect(SITE_ICD10_O2,"d46|c92|d.46|c.92|D46|C92"),1,NA)) %>%
  filter(!str_detect(SITE_ICD10_O2,"C921")) %>% 
  filter(!is.na(MDSAML)) %>% 
  select(PSEUDO_PAT,MDSAML,DIAGNOSISDATEBEST, SITE_ICD10_O2) %>% 
  arrange(PSEUDO_PAT, DIAGNOSISDATEBEST) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  ungroup()

NCRD_MDS %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  ungroup() %>% 
  count(MDSAML) #N=15 patients with a diagnosis of MDS or AML in the  NCRD registry

NCRD_MDS_LIST<- NCRD_MDS

NCRD_MDS_LIST %>% 
  count(PSEUDO_PAT) #n=15 patients with MDS or AML diagnosis in the cancer registry
```
Read in HES data. This uses raw tables as updated methodology for thesis:
```{r}
#Create  list of included patients:
filterlist<-ovariancohort %>% 
  distinct(PSEUDO_PAT)
#Import HES APC records:
HESDIAGNOSIS1<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG2122_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS2<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG2021_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS3<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1920_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS4<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1819_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS5<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1718_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS6<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1617_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS7<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1516_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS8<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1415_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS9<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1314_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS10<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1213_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS11<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1112_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESDIAGNOSIS12<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1011_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")

#Read HES APC files containing visit date details
hesapc1<-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\RStudio\\ODR1920_080_HESAPC_1619_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT") %>% 
  select(PSEUDO_PAT, PSEUDO_EPIKEYANON, ADMIDATE,DATAYEAR)
hesapc2<-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\RStudio\\ODR1920_080_HESAPC_1013_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT") %>% 
  select(PSEUDO_PAT, PSEUDO_EPIKEYANON, ADMIDATE,DATAYEAR)
hesapc3<-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\RStudio\\ODR1920_080_HESAPC_1316_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT") %>% 
  select(PSEUDO_PAT, PSEUDO_EPIKEYANON, ADMIDATE,DATAYEAR)
hesapc4<-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\RStudio\\ODR1920_080_HESAPC_22_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT") %>% 
  select(PSEUDO_PAT, PSEUDO_EPIKEYANON, ADMIDATE,DATAYEAR)
#Bind HES APC files to get admission dates
hes_acp_files<-rbind(hesapc1,hesapc2,hesapc3,hesapc4)

#Import HES OP records
HESOPDIAGNOSIS1<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG2122_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS2<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG2021_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS3<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1920_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS4<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1819_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS5<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1718_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL) %>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS6<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1617_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS7<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1516_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS8<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1415_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS9<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1314_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS10<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1213_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS11<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1112_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")
HESOPDIAGNOSIS12<-read_csv(
  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1011_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")


#Join HES APC data and write.csv
HES_all_data_bind1<-rbind(HESDIAGNOSIS1,HESDIAGNOSIS2)
HES_all_data_bind2<-rbind(HESDIAGNOSIS3,HESDIAGNOSIS4)
HES_all_data_bind3<-rbind(HESDIAGNOSIS5,HESDIAGNOSIS6)
HES_all_data_bind4<-rbind(HESDIAGNOSIS7,HESDIAGNOSIS8)
HES_all_data_bind5<-rbind(HESDIAGNOSIS9,HESDIAGNOSIS10)
HES_all_data_bind6<-rbind(HESDIAGNOSIS11,HESDIAGNOSIS12)
HES_bind12<-rbind(HES_all_data_bind1,HES_all_data_bind2)
HES_bind34<-rbind(HES_all_data_bind3,HES_all_data_bind4)
HES_bind56<-rbind(HES_all_data_bind5,HES_all_data_bind6)
HES_APC_data<-rbind(HES_bind12, HES_bind34,HES_bind56) %>% arrange(PSEUDO_PAT, DATAYEAR)
HES_APC_data#n=XXXX, %% of total of 6,536 patients

#Select columns
HES_APC_data<-HES_APC_data%>% 
  select(PSEUDO_PAT,PSEUDO_EPIKEYANON, DATAYEAR, DIAG4_01:DIAG4_12)

#Merge with HES APC 
hes_apc_final<-HES_APC_data %>% 
  left_join(hes_acp_files, by = c("PSEUDO_PAT","DATAYEAR" ,"PSEUDO_EPIKEYANON"))

#Write HES APC table
HES_APC_data%>% 
  write_csv("HES_APC_DIAG_10DEC25.csv")

HES_APC_data%>% 
  count(PSEUDO_PAT)#n=10,922 of 10,940 (#99.8% represented)
```


```{r}
#Bind HES OP and write full file:
HESOPDIAGNOSIS12<-rbind(HESOPDIAGNOSIS1,HESOPDIAGNOSIS2)
HESOPDIAGNOSIS34<-rbind(HESOPDIAGNOSIS3,HESOPDIAGNOSIS4)
HESOPDIAGNOSIS56<-rbind(HESOPDIAGNOSIS5,HESOPDIAGNOSIS6)
HESOPDIAGNOSIS78<-rbind(HESOPDIAGNOSIS7,HESOPDIAGNOSIS8)
HESOPDIAGNOSIS910<-rbind(HESOPDIAGNOSIS9,HESOPDIAGNOSIS10)
HESOPDIAGNOSIS1112<-rbind(HESOPDIAGNOSIS11,HESOPDIAGNOSIS12)
HES_apocoperbind12<-rbind(HESOPDIAGNOSIS12,HESOPDIAGNOSIS34)
HES_apocoperbind34<-rbind(HESOPDIAGNOSIS56,HESOPDIAGNOSIS78)
HES_apocoperbind56<-rbind(HESOPDIAGNOSIS910,HESOPDIAGNOSIS1112)
HES_OP_data<-rbind(HES_apocoperbind12, HES_apocoperbind34,HES_apocoperbind56) %>% arrange(PSEUDO_PAT, DATAYEAR)
rm(HES_apocoperbind12,HES_apocoperbind34,HES_apocoperbind56)
rm(HESOPDIAGNOSIS1,HESOPDIAGNOSIS2,HESOPDIAGNOSIS3,HESOPDIAGNOSIS4,HESOPDIAGNOSIS5,HESOPDIAGNOSIS6,HESOPDIAGNOSIS7,HESOPDIAGOSIS8,HESOPDIAGNOSIS9,HESOPDIAGNOSIS10,HESOPDIAGNOSIS11,HESOPDIAGNOSIS12)

HES_OP_data<-HES_OP_data%>% 
  select(PSEUDO_PAT, DATAYEAR, DIAG4_01:DIAG4_12) %>% 
  merge(filterlist, by = "PSEUDO_PAT")

HES_OP_data %>% 
  write.csv("HES_OP_DIAG_10DEC25.csv")

HES_OP_data%>% 
  count(PSEUDO_PAT)#n=10,922 of 10,940 represented
```

Study outcome:
Identify MDS/AML in the HES APC, OPC and A&E datasets
```{r}
hes_apc_final %>% 
  count(PSEUDO_PAT) #N=10,922 of 10,940 patients in total in the HESAPC gynae data

HESAPCMDS<- hes_apc_final %>% 
  merge(filterlist, by ="PSEUDO_PAT")

HESAPCMDS %>% 
  count(PSEUDO_PAT) #n=10,922 patients of 10,940 have a record in the HES APC data

HESAPCMDS<-HESAPCMDS %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_01,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,NA)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_02,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_03,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_04,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_05,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_06,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_07,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_08,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_09,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_10,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_11,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_12,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) 

HESAPCMDS %>% 
  filter(MDSAML==1) %>% 
  count(PSEUDO_PAT) #N=10 patients with a diagnosis of MDS or AML in the HES APC data
```

Identify MDS/AML diagnoses in the HES outpatient datasets:
```{r}
HES_OP_data %>% 
  count(PSEUDO_PAT) #N=10,922 patients in total in the HESOPC gynae data

HESOPCMDS<-HES_OP_data %>% 
     merge(filterlist, by ="PSEUDO_PAT") %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_01,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,NA)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_02,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_03,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_04,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_05,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_06,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_07,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_08,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_09,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_10,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_11,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG4_12,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) 

HESOPCMDS %>% 
  filter(MDSAML==1) %>% 
  count(PSEUDO_PAT)#N=0 patients with a diagnosis of MDS or AML in the HES OPC data
```

Check for MDS/AML diagnoses in the HES A&E datasets:
```{r}
hes_ae<-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Rstudio\\HES data link\\ODR1920_080_HESAE_DIAG_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)%>% 
  merge(filterlist, by = "PSEUDO_PAT")


hes_ae %>% 
  count(PSEUDO_PAT) #N=8,130/10,940 patients in total in the HES A&E  data

HESAEMDS<-hes_ae %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_01,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,NA)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_02,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_03,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_04,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_05,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_06,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_07,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_08,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_09,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
     mutate(MDSAML=ifelse(str_detect(DIAG_10,"d.46|c.92|D46|C920|C925|C926|C92A|C92Z|C929"),1,MDSAML)) %>% 
  distinct(PSEUDO_PAT,.keep_all=T)

HESAEMDS %>% 
  filter(MDSAML==1) %>% 
  count(PSEUDO_PAT) #N=0 patients with a diagnosis of MDS or AML in the HES A&E data
```

Then rbind the HES data together to generate one file with all the patients diagnosed with MDS AML.
This may need amending to align the columns:
```{r}
NCRD_MDS_LIST%>% 
  mutate(MDSAML=1) %>% 
  count(PSEUDO_PAT) #N=15 in the NCRD

HESAPCMDS %>% 
  filter(MDSAML==1) %>% 
  count(PSEUDO_PAT) #n=10 in the HES APC

HESOPCMDS %>% 
  filter(MDSAML==1) %>% 
  count(PSEUDO_PAT) #n=0 in the HES admitted patient care

HESAEMDS %>% 
  filter(MDSAML==1) %>% 
  count(PSEUDO_PAT) #n=0 in the HES outpatient data


#Organise the columns into similar terms so the data can be rbinded:
HESAPCMDS<-HESAPCMDS %>% 
  select(PSEUDO_PAT,ADMIDATE,DATAYEAR, DIAG4_01:DIAG4_12,MDSAML)

HESOPCMDS<-HESOPCMDS %>% 
  mutate(ADMIDATE=" ") %>% 
  select(PSEUDO_PAT,ADMIDATE,DATAYEAR, DIAG4_01:DIAG4_12,MDSAML)
  
NCRD_MDS_LIST<-NCRD_MDS_LIST %>% 
  mutate(MDSAML=1) %>% 
  mutate(ADMIDATE=dmy(DIAGNOSISDATEBEST)) %>% 
  mutate(DATAYEAR=" ") %>% 
  mutate(DIAG4_01=SITE_ICD10_O2) %>% 
  mutate(DIAG4_02=SITE_ICD10_O2) %>% 
  mutate(DIAG4_03=SITE_ICD10_O2) %>% 
  mutate(DIAG4_04=SITE_ICD10_O2) %>% 
  mutate(DIAG4_05=SITE_ICD10_O2) %>% 
  mutate(DIAG4_06=SITE_ICD10_O2) %>% 
  mutate(DIAG4_07=SITE_ICD10_O2) %>% 
  mutate(DIAG4_08=SITE_ICD10_O2) %>% 
  mutate(DIAG4_09=SITE_ICD10_O2) %>% 
  mutate(DIAG4_10=SITE_ICD10_O2) %>% 
  mutate(DIAG4_11=SITE_ICD10_O2) %>% 
  mutate(DIAG4_12=SITE_ICD10_O2) %>% 
  select(PSEUDO_PAT,ADMIDATE,DATAYEAR, DIAG4_01:DIAG4_12,  ,MDSAML)

HESAPCMDS<-HESAPCMDS %>% 
  mutate(ADMIDATE=dmy(ADMIDATE))

allHESdata<-rbind(HESAPCMDS,NCRD_MDS_LIST)

allHESdata %>%
  filter(MDSAML==1) %>% 
  count(PSEUDO_PAT) #N=17 patients in total when joining HES and NCRD diagnoses
```

Create the diagnosis list. To do this, order by PSEUDO_PAT and ADMI_DATE and keep the first instance.
```{r}
allHESdata %>% 
  count(PSEUDO_PAT) #N=17 patients of 10,940 (0.32%) total with MDS or AML diagnosis in NCRAS, HES APC or HES OPC

allHESdata %>% 
  filter(MDSAML==1) %>% 
  count(PSEUDO_PAT) #N=17 = all patients preserved with date where available

allHESdata %>% 
  filter(MDSAML==1) %>% 
  write_csv("diagnosislist.csv")
```



6: Link surgeries
```{r}
ovariancohort #n=199,815 lines in total
  
ovariancohort %>% 
  count(PSEUDO_PAT) #n=10,940 patients

#select hysterectomy, salping and omentectomy. Arranged by date and keeping the distinct first line to keep first instance of surgery for each patient
treatments<-treatments %>% 
  filter(str_detect(OPCS4_NAME,"hysterectomy|SALPING|HYSTERECTOMY|salping")) %>% 
  distinct(PSEUDO_PAT, EVENTDATE,.keep_all=T) %>% 
  select(PSEUDO_PAT,PSEUDO_TUMOURID, EVENTDATE, OPCS4_NAME) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  right_join(ovariancohort, by = "PSEUDO_PAT", "PSEUDO_TUMOURID") %>% 
  distinct(PSEUDO_PAT, ADMINISTRATION_DATE, DRUG_GROUP,.keep_all=T) %>% 
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
  ungroup()

treatments %>% count(PSEUDO_PAT) #n=10,940 patients in the treatment data

ovariancohort %>% count(PSEUDO_PAT) #n=10,940 CHECK ALL PATIENTS PRESERVED - yes
```


n=10,940 before this exclusion.
Filter those who receive only cycle of PARPi:
n=10,824 after this exclusion.
```{r}
ovariancohort %>%   count(PSEUDO_PAT) #N=10,940

#Create table for patients who had one cycle of PARPi
one_cycle_parp<-ovariancohort %>% 
  group_by(PSEUDO_PAT) %>%
  mutate(parp=ifelse(str_detect(DRUG_GROUP, "OLAPARIB|NIRAPARIB|RUCAPARIB"),1,0)) %>% 
  mutate(numbercyclesparp=sum(parp)) %>% 
  fill(numbercyclesparp,.direction = "updown") %>% 
  mutate(exclusion=ifelse(numbercyclesparp==1,1,NA)) %>% 
  fill(exclusion,.direction = "updown") %>% 
  #mutate(exclusion=ifelse(is.na(exclusion),0,exclusion)) %>% 
  filter(exclusion==1)

one_cycle_parp %>%
  ungroup() %>% 
  count(PSEUDO_PAT) #n=116 patients had 1 cycle of PARPi

ovariancohort2<-ovariancohort %>% 
  group_by(PSEUDO_PAT) %>%
  mutate(parp=ifelse(str_detect(DRUG_GROUP, "OLAPARIB|NIRAPARIB|RUCAPARIB"),1,0)) %>% 
  mutate(numbercyclesparp=sum(parp)) %>% 
  fill(numbercyclesparp,.direction = "updown") %>% 
  mutate(exclusion=ifelse(numbercyclesparp>1|(is.na(frontline)&is.na(recurrent)),1,NA)) %>% 
  fill(exclusion,.direction = "updown") %>% 
  #mutate(exclusion=ifelse(is.na(exclusion),0,exclusion)) %>% 
  filter(exclusion==1)

ovariancohort2 %>%
  ungroup() %>% 
  count(PSEUDO_PAT) #n=10,824


#Create flag for patients with number of cycles for later linkage.
parp_cycles<-ovariancohort2 %>% 
  group_by(PSEUDO_PAT) %>%
  mutate(parp=ifelse(str_detect(DRUG_GROUP, "OLAPARIB|NIRAPARIB|RUCAPARIB"),1,NA)) %>% 
  mutate(numbercyclesparp=sum(parp)) %>% 
  fill(numbercyclesparp,.direction = "updown") %>% ungroup() %>% 
  distinct(PSEUDO_PAT, numbercyclesparp) %>% 
  count(numbercyclesparp)
```

n=10,824 before this exclusion
Exclude patients who received PARP as first record of SACT (without chemotherapy)
n=0 excluded
N=10,824 after this exclusion
```{r}
ovariancohort2 %>%
  count(PSEUDO_PAT) #N=10,824

ovariancohort3<-ovariancohort2 %>% 
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(!str_detect(DRUG_GROUP, "NIRAPARIB|OLAPARIB|RUCAPARIB")) %>% 
  select(PSEUDO_PAT) %>% 
  merge(ovariancohort, by ="PSEUDO_PAT") %>% 
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
  ungroup()

ovariancohort3 %>% 
  count(PSEUDO_PAT) #N=10,824 total patients, 0 excluded
```

n=10,824 before this exclusion
Exclude patients who have been labelled with only PLD as first-line.
n=0 patients excluded
n=10,824 after this exclusion
```{r}
ovariancohort3 %>% 
  count(PSEUDO_PAT) #n=10,824

ovariancohort3<-ovariancohort3 %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  arrange(PSEUDO_PAT, lineoftherapy) %>% 
  filter(!DRUG_GROUP=="LIPOSOMAL DOXORUBICIN (CAELYX)"&lineoftherapy==1) %>% 
  distinct(PSEUDO_PAT) %>% 
  merge(ovariancohort3, by = "PSEUDO_PAT") 

ovariancohort3 %>% count(PSEUDO_PAT) #n=10,824 here

#n=0 excluded as PLD was removed from the dataset previously. Those who only had PLD listed would not appear here.
```

n=10,824 before
Filter patients who have SACT record after death in error.
N=0 patients excluded here
n=10,824 after
```{r}
ovariancohort3 %>% count(PSEUDO_PAT) #n=10,824 here

exclusion<-ovariancohort3 %>%
  mutate(VITALSTATUSDATE=dmy(VITALSTATUSDATE)) %>% 
    mutate(ADMINISTRATION_DATE=as.Date(ADMINISTRATION_DATE)) %>% 
  select(ADMINISTRATION_DATE,VITALSTATUSDATE,VITALSTATUS,PSEUDO_PAT) %>% 
   filter(ADMINISTRATION_DATE>VITALSTATUSDATE)%>%
   filter(str_detect(VITALSTATUS,"D"))

exclusion %>% count(PSEUDO_PAT)#N=0 patients excluded because of death recorded after SACT adminstration

ovariancohort3 %>% count(PSEUDO_PAT) #n=10,824
```

Rename the final analysis cohort;
```{r}
analysiscohort<-ovariancohort3
```

Add labels for setting of PARP:
```{r}
analysiscohort %>% 
  count(PSEUDO_PAT) #n=10,824

analysiscohort %>% 
  select(DRUG_GROUP, ADMINISTRATION_DATE, lineoftherapy)

analysiscohort<-analysiscohort %>% 
 mutate(olaparibfirstline=ifelse(lineoftherapy==1&DRUG_GROUP=="OLAPARIB",1,NA)) %>% 
 mutate(niraparibfirstline=ifelse(lineoftherapy==1&DRUG_GROUP=="NIRAPARIB",1,NA)) %>% 
 mutate(rucaparibfirstline=ifelse(lineoftherapy==1&DRUG_GROUP=="RUCAPARIB",1,NA)) %>% 
 mutate(olaparibrecurrent=ifelse(lineoftherapy>1&DRUG_GROUP=="OLAPARIB",1,NA)) %>% 
 mutate(niraparibrecurrent=ifelse(lineoftherapy>1&DRUG_GROUP=="NIRAPARIB",1,NA)) %>% 
 mutate(rucaparibrecurrent=ifelse(lineoftherapy>1&DRUG_GROUP=="RUCAPARIB",1,NA)) %>% 
 mutate(olaparibrecurrent=ifelse(lineoftherapy>1&DRUG_GROUP=="OLAPARIB",1,NA)) %>% 
 mutate(niraparibrecurrent=ifelse(lineoftherapy>1&DRUG_GROUP=="NIRAPARIB",1,NA)) %>% 
 mutate(rucaparibrecurrent=ifelse(lineoftherapy>1&DRUG_GROUP=="RUCAPARIB",1,NA)) %>% 
 group_by(PSEUDO_PAT) %>% 
 fill(olaparibfirstline, .direction = "updown") %>% 
 fill(niraparibfirstline, .direction = "updown") %>% 
 fill(rucaparibfirstline, .direction = "updown") %>% 
 fill(olaparibrecurrent, .direction = "updown") %>% 
 fill(niraparibrecurrent, .direction = "updown") %>% 
 fill(rucaparibrecurrent, .direction = "updown") %>% 
 fill(olaparibrecurrent, .direction = "updown") %>% 
 fill(niraparibrecurrent, .direction = "updown") %>% 
 fill(rucaparibrecurrent, .direction = "updown")

```
N=10,824 before

Finally, exclude patients who had more than one PARP in the recurrent setting as this causes the totals to add up incorrectly and is confusing. N=12 excluded here. 
n=13 excluded here for switching PARPi

N=10,814 after 
n=10 excluded
```{r}
analysiscohort %>% 
  count(PSEUDO_PAT) #n=10,824

analysiscohort %>%
  group_by(PSEUDO_PAT) %>% 
  fill(olaparibfirstline,.direction="updown") %>%
  fill(rucaparibrecurrent,.direction="updown") %>%
  fill(niraparibrecurrent,.direction="updown") %>%
  mutate(filter=ifelse(olaparibfirstline==1,NA)) %>% 
  mutate(filter=ifelse(niraparibfirstline==1,filter)) %>% 
   mutate(filter=ifelse(rucaparibfirstline==1,filter)) %>% 
  mutate(filter=ifelse((olaparibrecurrent==1&niraparibrecurrent==1),1,filter)) %>% 
  mutate(filter=ifelse((rucaparibrecurrent==1&niraparibrecurrent==1),1,filter)) %>% 
  mutate(filter=ifelse((olaparibrecurrent==1&rucaparibrecurrent==1),1,filter)) %>% 
  fill(filter,.direction="updown") %>% 
  filter(filter==1) %>% 
  count(PSEUDO_PAT)

analysiscohort<-analysiscohort %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(olaparibrecurrent,.direction="updown") %>%
  fill(rucaparibrecurrent,.direction="updown") %>%
  fill(niraparibrecurrent,.direction="updown") %>%
  mutate(filter=ifelse(!is.na(olaparibrecurrent)&!is.na(niraparibrecurrent),1,NA)) %>% 
  mutate(filter=ifelse(!is.na(rucaparibrecurrent)&!is.na(niraparibrecurrent),1,filter)) %>% 
  mutate(filter=ifelse(!is.na(olaparibrecurrent)&!is.na(rucaparibrecurrent),1,filter)) %>% 
  fill(filter,.direction="updown") %>% ungroup() %>% 
  filter(is.na(filter)) %>% 
  filter(is.na(niraparibfirstline)) %>% 
  filter(is.na(rucaparibfirstline)) %>% 
  filter(is.na(olaparibfirstline)) %>% 
  ungroup() 

analysiscohort %>% 
  count(PSEUDO_PAT) #n=10,814
```

N=10,814  BFEORE 
EJC COMMENT: FILTER OUT PATIENTS WHO HAD PLD OR DOXORUBICIN IN FIRST LINE
N=10,363 AFTER EXCLUSION
```{r}
analysiscohort %>% 
  count(PSEUDO_PAT)

analysiscohort %>% 
  count(DRUG_GROUP)

analysiscohort<-analysiscohort %>% 
  mutate(PLD_first_line=ifelse(str_detect(DRUG_GROUP, "LIPOSOM|DOXORU")&lineoftherapy==1,1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(PLD_first_line,.direction="updown") %>% 
  filter(is.na(PLD_first_line))

analysiscohort %>% 
  count(PSEUDO_PAT) #N=10,363
```


Write CSV for the final analysis table:
```{r}
analysiscohort %>% 
  write_csv("PARP_cohort10JUL24.csv")
```

Read in for future ease of use.
```{r}
analysiscohort<-read_csv("PARP_cohort10JUL24.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)
```
N=11989
```{r}
analysiscohort %>% 
  count(PSEUDO_PAT) #n=10,363
```

ANALYSIS 
####################################
Now need to check that MDS and AML diagnoses are linked to the dataset. If not , use the DIAGNOSISLIST.
####################################

Define time from initiation of therapy to MDS/AML:
This will use the  INDEX date of 8-weeks post end first-line chemotherapy, as patients would be expected to start PARPi within 8-12 weeks of completing first-line platinum chemo.
Do not use DISDATE as this contains missing data.
```{r}
analysiscohort %>% 
  filter(lineoftherapy==1) %>% 
  count(DRUG_GROUP)

#Create index date of first SACT. This should be 8 weeks after completion of first-line chemotherapy
analysiscohort<-analysiscohort %>% 
  distinct(PSEUDO_PAT,ADMINISTRATION_DATE, DRUG_GROUP,.keep_all=T) %>% 
  arrange(PSEUDO_PAT,ADMINISTRATION_DATE) %>% 
  group_by(PSEUDO_PAT) %>%
  mutate(ADMINISTRATION_DATE=as.Date(ADMINISTRATION_DATE)) %>%
  filter(lineoftherapy==1&str_detect(DRUG_GROUP,"CISPLATIN|CARBOPLATIN|PACLITAXEL")) %>% 
  group_by(PSEUDO_PAT) %>% 
  mutate(INDEX=max(ADMINISTRATION_DATE)+56) %>% #index date is 8 weeks post completion of first-line chemotherapy
  select(PSEUDO_PAT, INDEX) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  right_join(analysiscohort, by = "PSEUDO_PAT")
```

Join the MDS AML diagnoses to the dataset with the first date of diagnosis retained for each patient
```{r}
diagnosislist<-read_csv("diagnosislist.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)

diagnosislist %>% 
  count(PSEUDO_PAT)  #n=17 patients have a  diagnosis of MDS/AML listed in HES after exclusion criteria are applied
```

Calculate secondary diagnosis time as index date of 8 weeks post-initiation of chemo to MDSAML date
```{r}
diagnosislist<-diagnosislist %>% 
  mutate(ADMIDATE=ifelse(is.na(ADMIDATE), DATAYEAR,ADMIDATE)) %>% #use datayear where exact date is not provided (HES APC)
  mutate(ADMIDATE=ifelse(ADMIDATE=="1920","2019-01-07",ADMIDATE)) %>% 
  mutate(ADMIDATE=ifelse(ADMIDATE=="2021","2021-01-07",ADMIDATE)) %>% 
  mutate(ADMIDATE=as.Date(ADMIDATE)) %>% 
  arrange(PSEUDO_PAT, ADMIDATE) %>%  #retain first record of MDS/AML only
  distinct(PSEUDO_PAT,.keep_all=T) 

mdsamltable2<-analysiscohort %>%
  left_join(diagnosislist, by = "PSEUDO_PAT") %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% #n=10,363 pts in total
  mutate(SECONDARYDIAGNOSIS=as.numeric(difftime(ADMIDATE,INDEX, units = "days"))) %>% 
  select(PSEUDO_PAT,INDEX,ADMIDATE, SECONDARYDIAGNOSIS, DIAG4_01:MDSAML) %>% 
  mutate(MDS=ifelse(str_detect(DIAG4_01,"D46")|str_detect(DIAG4_02,"D46")|str_detect(DIAG4_03,"D46")|str_detect(DIAG4_04,"D46")|str_detect(DIAG4_05,"D46")|str_detect(DIAG4_06,"D46")|str_detect(DIAG4_07,"D46")|str_detect(DIAG4_08,"D46")|str_detect(DIAG4_09,"D46")|str_detect(DIAG4_10,"D46")|str_detect(DIAG4_11,"D46")|str_detect(DIAG4_12,"D46"),1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(MDS,.direction = "updown") %>% 
    mutate(AML=ifelse(str_detect(DIAG4_01,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_01,"C921")|str_detect(DIAG4_02,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_02,"C921")|str_detect(DIAG4_03,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_03,"C921")|str_detect(DIAG4_04,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_04,"C921")|str_detect(DIAG4_05,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_05,"C921")|str_detect(DIAG4_06,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_06,"C921")|str_detect(DIAG4_07,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_07,"C921")|str_detect(DIAG4_08,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_08,"C921")|str_detect(DIAG4_09,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_09,"C921")|str_detect(DIAG4_10,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_10,"C921")|str_detect(DIAG4_11,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_11,"C921")|str_detect(DIAG4_12,"C920|C925|C926|C92A|C92Z|C929")&!str_detect(DIAG4_12,"C921"),1,NA)) %>% 
  fill(MDS,.direction = "updown") %>% 
  ungroup()

analysiscohort<-mdsamltable2 %>% 
  select(PSEUDO_PAT, SECONDARYDIAGNOSIS, MDS, AML) %>% 
  right_join(analysiscohort, by = "PSEUDO_PAT") #This join is correct

analysiscohort %>% 
  count(PSEUDO_PAT) #N=10,363
```

Define event as diagnosis of MDS/AML within 5 years of completion of first line chemotherapy:
```{r}
analysiscohort<-analysiscohort %>% 
  mutate(SECONDARYDIAGNOSIS=ifelse(SECONDARYDIAGNOSIS<0|SECONDARYDIAGNOSIS>1825,NA,SECONDARYDIAGNOSIS)) %>% 
  mutate(EVENT=ifelse(SECONDARYDIAGNOSIS<1826&SECONDARYDIAGNOSIS>0,1,0)) %>% 
  mutate(EVENT=ifelse(is.na(EVENT),0,EVENT))#This code ignores diagnoses before the index date (i.e. before treatment for ovarian cancer)

analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  ungroup() %>% 
  count(EVENT) #n=11 diagnoses within 5 years of completion of first-line chemo, n=10,352 have no secondary mds/aml
```

EJC COMMENT: GIVE TIME TO DIAGNOSIS IN DAYS - CURRENTLY MIX OF DAYS AND YEARS
```{r}
analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  ungroup() %>% 
  filter(EVENT==1) %>% 
  select(SECONDARYDIAGNOSIS) %>% 
  summary()

#SECONDARYDIAGNOSIS
# Min.   : 215.0    
# 1st Qu.: 484.5    
# Median : 700.0    
# Mean   : 824.9    
# 3rd Qu.:1219.5    
# Max.   :1470.0 
```


Cleaning of data for summary tables:
```{r}
analysiscohort<-analysiscohort %>% 
  mutate(AGE=as.numeric(AGE))
analysiscohort$AGE2<-cut(analysiscohort$AGE, breaks=c(0,50,60,70,150))
analysiscohort<-analysiscohort %>% 
  mutate(BMI=as.numeric(BMI))
analysiscohort$BMI2<-cut(analysiscohort$BMI, breaks=c(0,18.5,25,30,40,99))
analysiscohort<-analysiscohort %>% 
  mutate(PS=as.numeric(PS))
analysiscohort$PS<-cut(analysiscohort$PS, breaks=c(0,1,2, 3, 4, 5,10))
analysiscohort<-analysiscohort %>% 
  mutate(VITALSTATUS=ifelse(str_detect(VITALSTATUS,"D"),"D",VITALSTATUS)) %>% 
  mutate(VITALSTATUS=ifelse(str_detect(VITALSTATUS,"X"),"Unknown",VITALSTATUS)) 
```

Count secondary MDS and AML diagnoses within 5 years of first-line chemotherapy start - this is for all patients whatever treatment was given.
```{r}
analysiscohort<-analysiscohort %>% 
  mutate(MDS=ifelse(EVENT==1,MDS,0)) %>% 
  mutate(AML=ifelse(EVENT==1,AML,0)) %>%
  ungroup()

analysiscohort<-analysiscohort %>% 
  mutate(AML=ifelse(is.na(AML),0,AML)) %>% 
  mutate(MDS=ifelse(is.na(MDS),0,MDS))

analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(MDS,AML)
# #n=2 developed MDS within 5 years. N=9 developed AML within 5 years. N=10,352 develop neither
```
EJC COMMENT: NEED TO DEFINE THE REGIMENS GIVEN AS CHEMO IN FIRST AND SECOND LINE
```{r}
first_line<-analysiscohort %>% 
  ungroup() %>% 
  select(PSEUDO_PAT, DRUG_GROUP, lineoftherapy) %>% 
  mutate(first_line_carbo=ifelse(str_detect(DRUG_GROUP,"CARBOPLATIN")&lineoftherapy==1,1,NA)) %>% 
  mutate(first_line_paclitaxel=ifelse(str_detect(DRUG_GROUP,"PACLITAXEL")&lineoftherapy==1,1,NA)) %>% 
  mutate(first_line_gemcitabine=ifelse(str_detect(DRUG_GROUP,"GEMCITABINE")&lineoftherapy==1,1,NA)) %>% 
  mutate(first_line_cisplatin=ifelse(str_detect(DRUG_GROUP,"CISPLATIN")&lineoftherapy==1,1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(everything(),.direction="updown") %>% 
  mutate(first_line_carbo_platinum=ifelse((first_line_carbo==1|first_line_cisplatin==1)&first_line_paclitaxel==1&is.na(first_line_gemcitabine),1,NA)) %>% 
  mutate(first_line_platinum_single=ifelse((first_line_carbo==1|first_line_cisplatin==1)&is.na(first_line_paclitaxel)&is.na(first_line_gemcitabine),1,NA)) %>% 
   mutate(first_line_paclitaxel_single=ifelse(first_line_paclitaxel==1&is.na(first_line_carbo)&is.na(first_line_gemcitabine)&is.na(first_line_cisplatin)==1,1,NA)) %>% 
   mutate(first_line_gem_single=ifelse(first_line_gemcitabine==1&is.na(first_line_paclitaxel)&is.na(first_line_carbo)&is.na(first_line_cisplatin)==1,1,NA)) %>% 
  mutate(first_line_gem_carbo=ifelse(first_line_carbo==1&first_line_gemcitabine==1&is.na(first_line_paclitaxel)&is.na(first_line_cisplatin),1,NA)) %>% 
  mutate(first_line_gem_paclitaxel=ifelse(first_line_paclitaxel==1&first_line_gemcitabine==1&is.na(first_line_carbo),1,NA)) %>% 
    mutate(first_line_cis_gem=ifelse(first_line_cisplatin==1&first_line_gemcitabine==1&is.na(first_line_paclitaxel)&is.na(first_line_carbo)&is.na(first_line_cisplatin),1,NA)) %>% 
   mutate(first_line_cisplatin_single=ifelse(first_line_cisplatin==1&is.na(first_line_gemcitabine)&is.na(first_line_paclitaxel)&is.na(first_line_carbo),1,NA)) %>% 
    fill(everything(),.direction="updown") %>% 
filter(lineoftherapy==1) 
```
Define 2nd line regimens:
```{r}
second_line<-analysiscohort %>% 
  ungroup() %>% 
  select(PSEUDO_PAT, DRUG_GROUP, lineoftherapy) %>% 
  mutate(second_line_carbo=ifelse(str_detect(DRUG_GROUP,"CARBOPLATIN")&lineoftherapy>1,1,NA)) %>% 
  mutate(second_line_doxorubicin=ifelse(str_detect(DRUG_GROUP,"DOXORUBICIN")&lineoftherapy>1,1,NA)) %>% 
  mutate(second_line_paclitaxel=ifelse(str_detect(DRUG_GROUP,"PACLITAXEL")&lineoftherapy>1,1,NA)) %>% 
  mutate(second_line_gemcitabine=ifelse(str_detect(DRUG_GROUP,"GEMCITABINE")&lineoftherapy>1,1,NA)) %>% 
  mutate(second_line_cisplatin=ifelse(str_detect(DRUG_GROUP,"CISPLATIN")&lineoftherapy>1,1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(everything(),.direction="updown") %>% 
  mutate(second_line_carbo_platinum=ifelse((second_line_carbo==1|second_line_cisplatin==1)&second_line_paclitaxel==1&is.na(second_line_gemcitabine),1,NA)) %>% 
  mutate(second_line_platinum_doxorubicin=ifelse((second_line_carbo==1|second_line_cisplatin==1)&second_line_doxorubicin==1,1,NA)) %>% 
  mutate(second_line_doxorubicin_single=ifelse(second_line_doxorubicin==1&is.na(second_line_paclitaxel)&is.na(second_line_gemcitabine)&is.na(second_line_carbo)&is.na(second_line_cisplatin),1,NA)) %>% 
  mutate(second_line_platinum_single=ifelse((second_line_carbo==1|second_line_cisplatin==1)&is.na(second_line_paclitaxel)&is.na(second_line_gemcitabine),1,NA)) %>% 
   mutate(second_line_paclitaxel_single=ifelse(second_line_paclitaxel==1&is.na(second_line_carbo)&is.na(second_line_gemcitabine)&is.na(second_line_cisplatin)==1,1,NA)) %>% 
  mutate(second_line_gem_single=ifelse(second_line_gemcitabine==1&is.na(second_line_paclitaxel)&is.na(second_line_carbo)&is.na(second_line_cisplatin)==1,1,NA)) %>% 
  mutate(second_line_gem_carbo=ifelse(second_line_carbo==1&second_line_gemcitabine==1&is.na(second_line_paclitaxel)&is.na(second_line_cisplatin),1,NA)) %>% 
  mutate(second_line_gem_paclitaxel=ifelse(second_line_paclitaxel==1&second_line_gemcitabine==1&is.na(second_line_carbo),1,NA)) %>% 

  mutate(second_line_cis_gem=ifelse(second_line_cisplatin==1&second_line_gemcitabine==1&is.na(second_line_paclitaxel)&is.na(second_line_carbo)&is.na(second_line_cisplatin),1,NA)) %>% 

  mutate(second_line_carbogemtaxol=ifelse(second_line_carbo==1&second_line_gemcitabine==1&second_line_paclitaxel==1,1,NA)) %>% 
  fill(everything(),.direction="updown") %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  ungroup() %>% 
  select(PSEUDO_PAT, 9:18)
```

Link chemo regimens:
```{r}
analysiscohort<-first_line %>% 
distinct(PSEUDO_PAT,.keep_all=T) %>% 
  select(-DRUG_GROUP) %>% 
  right_join(analysiscohort,by=c("PSEUDO_PAT","lineoftherapy"))

analysiscohort<-second_line %>% 
distinct(PSEUDO_PAT,.keep_all=T) %>% 
  right_join(analysiscohort,by=c("PSEUDO_PAT"))

analysiscohort<-analysiscohort %>%
  group_by(PSEUDO_PAT) %>% 
    fill(everything(),.direction="updown") %>% 
  ungroup()
```

Then collapse regimens into standard or non-standard:
```{r}
analysiscohort<-analysiscohort %>%
  mutate(standard_firstline=ifelse(first_line_carbo_platinum==1,1,NA)) %>%
  mutate(standard_firstline=ifelse(first_line_carbo==1,1,standard_firstline)) %>%
  mutate(standard_firstline=ifelse(is.na(standard_firstline),0,1)) %>% 
  mutate(standard_secondline=ifelse(second_line_platinum_doxorubicin==1|second_line_gem_carbo==1|second_line_carbo_platinum==1,1,NA)) %>% 
  mutate(standard_secondline=ifelse(is.na(standard_secondline),0,1)) 
```


Summary tables are now needed:
The treatment groups are quite misbalanced. PARPi patients are 5 years younger and the secondary diagonsis time is much longer - probably because they are younger and therefore have more time to experience the outcome due to longer survival. I can justify this through the 5-year follow up[ period imposed]
```{r}
library(gtsummary)
summarytabledata<-analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  ungroup() %>% 
  select(PSEUDO_PAT,EVENT,SECONDARYDIAGNOSIS,MDS, AML, AGE,AGE2,BMI, BMI2, VITALSTATUS, STAGE_BEST_CLEAN,IMD2015_1, PS, parpflag, linesbeforePARP,olaparibrecurrent,  niraparibrecurrent,rucaparibrecurrent,  ETHNICITYNAME,CENTRETYPE,REGION, bevacizumabflag,first_line_carbo_platinum,first_line_platinum_single,first_line_paclitaxel_single,first_line_gem_single,first_line_gem_carbo,first_line_gem_paclitaxel,first_line_cis_gem,first_line_cisplatin_single,second_line_carbo_platinum,second_line_platinum_doxorubicin,second_line_doxorubicin_single,second_line_platinum_single,second_line_paclitaxel_single,second_line_gem_carbo,second_line_gem_paclitaxel,second_line_cis_gem,standard_firstline,standard_secondline)

summarytabledata<-summarytabledata %>% 
  mutate(parpflag=ifelse(is.na(parpflag),0,parpflag))

bevatable<-read_csv("beva_flag_table.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)

summarytabledata<-summarytabledata %>% 
  merge(bevatable, by = "PSEUDO_PAT") %>% 
  select(-bevacizumabflag.x) %>% 
  rename(bevacizumabflag=bevacizumabflag.y) %>% 
  mutate(bevacizumabflag=ifelse(is.na(bevacizumabflag),0,1))

baselinetable<-summarytabledata %>% 
  select(-PSEUDO_PAT) %>% 
ungroup() %>% 
  tbl_summary(by="parpflag") %>% 
  add_overall() %>% 
  add_p() %>% 
  add_n()

baselinetable %>% 
  as_gt() %>% 
  gt::gtsave("parpi_tableone.docx")
```

```{r}
comparisonofdiagnoses<-analysiscohort %>% 
    distinct(PSEUDO_PAT,.keep_all=T) %>% 
  mutate(parpflag=ifelse(is.na(parpflag),0,parpflag)) %>% 
  select(MDS, AML,SECONDARYDIAGNOSIS,parpflag) %>%
  tbl_summary(by="parpflag") %>% 
  add_overall() %>% 
  add_p()

comparisonofdiagnoses %>% 
  as_gt() %>% 
  gt::gtsave("diagnosis10dec25.docx")
```

Investigate the outcome of secondary diagnosis within 5 years of end of chemo.
```{r}
summarytabledata %>% 
  filter(!is.na(SECONDARYDIAGNOSIS)) %>% 
  select(SECONDARYDIAGNOSIS,parpflag, MDS, AML) %>% 
  tbl_summary(by="parpflag") %>% 
  add_overall() %>% 
  add_p() %>% 
  as_gt() %>% 
  gt::gtsave("timetodiagnosis.docx")

#median time to MDS/AML was 700 overall (418-1,244 IQR) days from index date of 8 weeks post 1st line chemo in patients treated with PARPi and chemo.
```

Comparison to the NOVA trial:
In NOVA, patients niraparib  in recurrent settings had incidence of MDS/AML of 1.36%.
We calculate this in the real-world cohort:
```{r}
NOVAdata<-analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(niraparibrecurrent==1)
  
NOVAdata  #N=770 patients who match the PAOLA specification. 

NOVAdata %>% 
  select(MDS, AML, SECONDARYDIAGNOSIS) %>% #May want to expand the variable list
  tbl_summary(by = NULL) 

#N=770 patients in the NOVAdata dataset. 1 developed MDS (0.1%), 1 developed AML (IQR 0.1%). 

NOVAdata %>% 
  filter(MDS==1|AML==1) %>% 
  select(SECONDARYDIAGNOSIS) %>% 
  summary()
#N=1, median time to diagnosis of MDS was 1300 days, IQR 1262-1339
```

Comparison to the SOLO3 trial:
In SOLO3, patients received olaparib single agent  in recurrent settings, with  incidence of MDS/AML of 2.25%.
We calculate this in the real-world cohort:
```{r}
SOLO3data<-analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(olaparibrecurrent==1)
  
SOLO3data  #N=222 patients who match the SOLO3 specification. 

SOLO3data %>% 
  select(MDS, AML, SECONDARYDIAGNOSIS) %>% #May want to expand the variable list
  tbl_summary(by = NULL) 

#N=222 patients in the SOLO3data dataset. 1 developed MDS  1 developed AML.
SOLO3data %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>%
  count(MDS,AML,SECONDARYDIAGNOSIS)

#N=1 median time to diagnosis of MDS was (335 days, IQR  335-335)
```

Comparison to ARIEL3 (niraparib, recurrent)
```{r}
ariel3<-analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(rucaparibrecurrent==1)
  
ariel3  #N=32 patients who match the SOLO3 specification. 

ariel3 %>% 
  select(MDS, AML, SECONDARYDIAGNOSIS) %>% #May want to expand the variable list
  tbl_summary(by = NULL) 

#N=32 patients in the SOLO3data dataset. 0 developed MDS  0 developed AML.
ariel3 %>% 
   distinct(PSEUDO_PAT,.keep_all=T) %>%
  count(MDS,AML)
```

Relative risk:
```{r}
#Relative risk calculated using Altmann 1991 methodology. 3,42, 95% CI 0.91, p=0.069).
```

Odds ratio for MDS and PARP.
This calculation doesn't run properly because of the very low event rate.
I've left the code in here for reference if reviewers question why adjusted relative risk wasn't calculated.
```{r}
analysiscohort<-analysiscohort %>% 
  mutate(bevacizumabflag=ifelse(is.na(bevacizumabflag),0,bevacizumabflag)) %>% 
  mutate(parpflag=ifelse(is.na(parpflag),0,parpflag))

library(gtsummary)
model<-glm(MDS~parpflag+AGE+ BMI+ STAGE_BEST_CLEAN+IMD2015_1+ETHNICITYNAME+CENTRETYPE+REGION+bevacizumabflag,data=analysiscohort)

#Summarise logistic regression
summary(model)

#Create summary table of odds ratios using exponentiated coefficients from glm above.
regression_table<-tbl_regression(model, exponentiate = TRUE)

#Save output of logistic regression analysis
regression_table %>% 
  as_gt() %>% 
  gt::gtsave("oddsratios_parpi_mds.docx")
```
Odds ratio for AML and PARP:
Again this method does not produce valid results as the event rate is low.
```{r}
model<-glm(AML~parpflag+AGE+ BMI+ STAGE_BEST_CLEAN+IMD2015_1+ETHNICITYNAME+CENTRETYPE+REGION+bevacizumabflag,data=analysiscohort)

#Summarise logistic regression
summary(model)

#Create summary table of odds ratios using exponentiated coefficients from glm above.
regression_table<-tbl_regression(model, exponentiate = TRUE)

#Save output of logistic regression analysis
regression_table %>% 
  as_gt() %>% 
  gt::gtsave("oddsratios_parpi_aml.docx")
```
As per David's comments, identify background rates of MDS/AML in the wider ovarian cancer population:
```{r}
#Filter for ovarian cancer patients:
backgroundpopulation<-read_csv("K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Rstudio\\PARPi Study 24JAN24\\ODR1920_080_AV_Tumour_2019Data_v2.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL) %>% 
  mutate(ovarian_flag=ifelse(str_detect(SITE_ICD10_O2,"c48|c56|c57|C48|C56|C57"),1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(ovarian_flag,.direction="updown") %>% 
  filter(ovarian_flag==1)

backgroundpopulation<-backgroundpopulation %>% 
  select(PSEUDO_PAT, SITE_ICD10_O2, DIAGNOSISDATEBEST,ovarian_flag) %>% 
  distinct(PSEUDO_PAT,SITE_ICD10_O2,.keep_all=T)

NCRD_MDS_BACKGROUND<-backgroundpopulation %>% 
  mutate(MDSAML=ifelse(str_detect(SITE_ICD10_O2,"d46|c92|d.46|c.92|D46|C92"),1,NA)) %>%
  filter(ovarian_flag==1) %>% 
  #filter(!is.na(MDSAML)) %>% 
  select(PSEUDO_PAT,MDSAML,DIAGNOSISDATEBEST, SITE_ICD10_O2) %>% 
  arrange(PSEUDO_PAT, DIAGNOSISDATEBEST) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  ungroup()

NCRD_MDS_BACKGROUND %>% 
  count(PSEUDO_PAT) #n=33,737 patients with any ovarian cancer diagnosis in NCRD

NCRD_MDS_BACKGROUND %>% 
  filter(str_detect(SITE_ICD10_O2, "C92|D46")) %>% #n=47 (0.14%) AML, 12 MDS (0.36%) of 33,373
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(SITE_ICD10_O2)
```


Describe median FU time:
```{r}
#For whole cohort
analysiscohort %>% 
  mutate(VITALSTATUSDATE=dmy(VITALSTATUSDATE)) %>%
 # mutate(ADMINISTRATION_DATE=dmy(ADMINISTRATION_DATE)) %>% 
  select(PSEUDO_PAT, VITALSTATUSDATE, ADMINISTRATION_DATE) %>% 
  mutate(FUtime=as.numeric(difftime(VITALSTATUSDATE,min(ADMINISTRATION_DATE),  units = "days"))) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  select(PSEUDO_PAT,FUtime) %>% 
  summary()

# PSEUDO_PAT            FUtime    
# Length:11531       Min.   :  34  
# Class :character   1st Qu.:1379  
# Mode  :character   Median :2071  
#                    Mean   :1905  
#                    3rd Qu.:2578  
#                    Max.   :2798  
#                    NA's   :10
#

#For PARPi only
analysiscohort %>% 
  mutate(VITALSTATUSDATE=dmy(VITALSTATUSDATE)) %>%
 # mutate(ADMINISTRATION_DATE=dmy(ADMINISTRATION_DATE)) %>% 
  select(PSEUDO_PAT, VITALSTATUSDATE, ADMINISTRATION_DATE,totalparptime) %>% 
  mutate(FUtime=as.numeric(difftime(VITALSTATUSDATE,min(ADMINISTRATION_DATE),  units = "days"))) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  select(PSEUDO_PAT,FUtime,totalparptime) %>% 
  filter(!is.na(totalparptime)) %>% 
  summary()
#PSEUDO_PAT            FUtime     totalparptime     
# Length:1024        Min.   :1125   Length:1024       
# Class :character   1st Qu.:2454   Class :character  
# Mode  :character   Median :2578   Mode  :character  
#                    Mean   :2481                     
#                    3rd Qu.:2579                     
#                    Max.   :279
#For chemo only
analysiscohort %>% 
  mutate(VITALSTATUSDATE=dmy(VITALSTATUSDATE)) %>%
 # mutate(ADMINISTRATION_DATE=dmy(ADMINISTRATION_DATE)) %>% 
  select(PSEUDO_PAT, VITALSTATUSDATE, ADMINISTRATION_DATE,totalparptime) %>% 
  mutate(FUtime=as.numeric(difftime(VITALSTATUSDATE,min(ADMINISTRATION_DATE),  units = "days"))) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  select(PSEUDO_PAT,FUtime,totalparptime) %>% 
  filter(is.na(totalparptime)) %>% 
  summary()

#PSEUDO_PAT            FUtime     totalparptime     
# Length:9339        Min.   :  34   Length:9339       
# Class :character   1st Qu.:1298   Class :character  
# Mode  :character   Median :1936   Mode  :character  
#                    Mean   :1842                     
#                    3rd Qu.:2578                     
#                    Max.   :2792                     
#                    NA's   :10         
```

Describe person-year time - the time spent on treatment in each treatment group for the study
```{r}
person_year_time<-  analysiscohort %>% 
  mutate(VITALSTATUSDATE=dmy(VITALSTATUSDATE)) %>%
  select(PSEUDO_PAT, VITALSTATUSDATE, DRUG_GROUP, ADMINISTRATION_DATE,lineoftherapy, totalparptime)  

person_year_time<-person_year_time%>% group_by(PSEUDO_PAT) %>%
  mutate(ADMINISTRATION_DATE=as.Date(ADMINISTRATION_DATE)) %>% 
  mutate(personyeartime=difftime(VITALSTATUSDATE,min(ADMINISTRATION_DATE), units = "days"))

#Person-year time for whole cohort
person_year_time %>%
  mutate(personyeartime=as.numeric(personyeartime)) %>% 
  summary()
#personyeartime
 #Min.   :   0.0  
 #1st Qu.: 554.0  
 #Median : 865.0  
 #Mean   : 966.6  
 #3rd Qu.:1276.0  
 #Max.   :2724.0  
 #NA's   :121

#Chemo only
person_year_time %>%
  filter(is.na(totalparptime)) %>% 
  mutate(personyeartime=as.numeric(personyeartime)) %>% 
  summary()
 #personyeartime  
#  Min.   :   0.0  
 #1st Qu.: 490.0  
 #Median : 764.0  
 #Mean   : 866.4  
 #3rd Qu.:1137.0  
 #Max.   :2724.0  
 #NA's   :121

person_year_time %>%
  filter(!is.na(totalparptime)) %>% 
  mutate(personyeartime=as.numeric(personyeartime)) %>% 
  summary()

# personyeartime
#Min.   : 142  
# 1st Qu.: 927  
# Median :1247  
# Mean   :1302  
# 3rd Qu.:1596  
# Max.   :256
```

Time on PARP therapy:
```{r}
analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(!is.na(totalparptime)) %>% 
  select(totalparptime) %>%
  mutate(totalparptime=as.numeric(totalparptime)) %>% 
  summary()
#median time on PARP was 191 days IQR 112, 365 days
```

Event rate in non-standard
```{r}
analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(standard_firstline==1) %>% 
  count(first_line_platinum_single,first_line_carbo_platinum,MDS,AML)


analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(standard_firstline==1) %>% 
  count(MDS,AML)

analysiscohort %>% 
  #distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(standard_firstline==0) %>%
  select(1:20, MDS, AML) %>% 
  filter(MDS==1|AML==1) 

analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(standard_firstline==0) %>% 
  count(MDS,AML)

analysiscohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  filter(is.na(standard_secondline)==1) %>% 
  count(MDS,AML) 
#no events in patients treated with non-standard first line
```
