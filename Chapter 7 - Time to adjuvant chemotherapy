Skip to content
Navigation Menu
lukesteventon
/
oxfordgynae

Type / to search
Code
Issues
Pull requests
Actions
Projects
Security
Insights
Settings
Files
Go to file
t
Chapter 4: Data descriptives
Chapter 4: Data linkage and cleaning of NCRAS and SACT datasets
Chapter 4: HES data linkage
HES-adjusted frailty score
Sex differences in biliary tract cancers
Study 1: Access to novel therapies
Study 2: Real-world outcomes for chemotherapy + bevacizumab
Study 3: The impact of adjuvant chemotherapy timing in advanced ovarian cancer
Study 4: Secondary incidence of MDS AML following PARPi therapy in advanced ovarian cancer
Breadcrumbsoxfordgynae
/Study 3: The impact of adjuvant chemotherapy timing in advanced ovarian cancer
Latest commit
lukesteventon
lukesteventon
Update Study 3: The impact of adjuvant chemotherapy timing in advance…
8a90b9a
 · 
last week
History
Breadcrumbsoxfordgynae
/Study 3: The impact of adjuvant chemotherapy timing in advanced ovarian cancer
File metadata and controls

Code

Blame
1765 lines (1516 loc) · 97.8 KB
---
title: "Study 3"
author: "Luke Steventon"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(mice)
library(broom)
library(ggplot2)
library(skimr)
library(survminer)
library(survival)
library(rbin)
library(readr)
library(here)
library(knitr)
library(gtsummary)
library(tinytex)
#setwd("K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Rstudio\\Surgery to adjuvant treatment")

setwd("K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Thesis Chapters\\Chapter 7 - Time to adjuvant chemotherapy")
load("treatment_table,.rda")
load("HESAPC.rda") #HES APC gynae cohort
trust_codes<-read_csv(
 "K:/QNAP/BRCT/SACT project/LSanalysis/Rstudio/Surgery to adjuvant treatment/trust_codes2.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL) #trust codes for NHS sites
load("HES_chemo.rda") #HES chemotherapy records of visits
#load("PSscore.rda")
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
getwd()
```

```{r}
#Apply updated cohort from 25NOV24 n=25713
#updatedovariancohort<-read_csv(
#  "gynae_sact_cohort_25NOV24.csv",
 # col_names = TRUE,
#  col_types = cols(.default = col_character()),
 # col_select = NULL) 

#Test with updated cohort 20NOV25
cohort<-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Rstudio\\ovarian_cohort20NOV.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL) 

demographic_table<-cohort %>% 
  select(PSEUDO_PAT, IMD2015_1, ETHNICITYNAME)%>% 
  distinct(PSEUDO_PAT,.keep_all=T)
```

Check specified cohort file is correct - n=23,774 patients.
```{r Diagnosis}
cohort %>% 
  count(PSEUDO_PAT) #n=23,774 

cohort %>% 
  skimr::skim()
```

Count missingness of stage data:
```{r}
cohort %>% 
  filter(is.na(STAGE_BEST_CLEAN)) %>% 
  count(PSEUDO_PAT) #n=4,188/23,774 with no stage data (17.6%)
```


n=23,774 before this exclusion
2d: Exclude patients listed as stage I, or IIA
n=16,876 after this step
n=4,188 excluded due to stage: N=4,188 have no stage data, n=2,710 are listed as early-stage disease <2B
```{r}
cohort %>% 
  ungroup() %>% 
  count(PSEUDO_PAT) #n=23,774

cohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(STAGE_BEST_CLEAN) 

#1	271			
#1A	644			
#1B	100			
#1C	786			
#2	377			
#2A	585			
#2B	676			
#2C	207			
#3	1805			
#3A	854
#3B	939			
#3C	6755			
#4	3879			
#4A	665			
#4B	1040			
#4C	3			
#NA	4188	

ovariansurgerycohort<-cohort %>% 
  ungroup() %>% 
  filter(!str_detect(STAGE_BEST_CLEAN,"0|1A|1a|1b|1c|1A|1B|1C|1a|2A|2a|IC")) %>% 
  filter(STAGE_BEST_CLEAN!="1") %>% 
  filter(STAGE_BEST_CLEAN!="2") %>% 
  filter(STAGE_BEST_CLEAN!="6") %>% 
  mutate(STAGE_BEST_CLEAN=ifelse(str_detect(STAGE_BEST_CLEAN, "4C"),"4",STAGE_BEST_CLEAN)) #4C is collapsed into stage 4 as there are very low numbers of patients which distorts the Cox regression analysis   filter(!is.na(STAGE_BEST_CLEAN)) 

ovariansurgerycohort %>% 
  ungroup() %>% 
  count(PSEUDO_PAT) #n=16,876

ovariansurgerycohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(STAGE_BEST_CLEAN) 

#2B	680			
#2C	208			
#3	1812			
#3A	858			
#3B	941			
#3C	6777			
#4	3893			
#4A	666			
#4B	1041		
```

Add a flag for bevacizumab maintenance therapy:
```{r}
ovariansurgerycohort<-ovariansurgerycohort %>% 
  mutate(bevflag=ifelse(DRUG_GROUP=="BEVACIZUMAB",1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(bevflag,.direction = "updown") %>% 
  select(PSEUDO_PAT, bevflag) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  merge(ovariansurgerycohort, by = "PSEUDO_PAT")

bevflagtable<-ovariansurgerycohort %>% 
  mutate(bevflag=ifelse(DRUG_GROUP=="BEVACIZUMAB",1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(bevflag,.direction = "updown") %>% 
  select(PSEUDO_PAT, bevflag) %>% 
  distinct(PSEUDO_PAT,.keep_all=T)
```


n=[16,876 before exclusion
1b: Exclusion remove drugs of non-interest: 
N=4,935 excluded here:
n=11,941 after exclusion.
```{r}
ovariansurgerycohort %>% 
  count(PSEUDO_PAT) #n=16,876 patients in total

ovariansurgerycohort %>% 
  count(DRUG_GROUP)

ovariansurgerycohort<-ovariansurgerycohort %>% 
    filter(str_detect(DRUG_GROUP,"CARBOPLATIN|CISPLATIN|PACLITAXEL|BEVACIZUMAB")) %>% 
    filter(DRUG_GROUP!="STEROID") %>%
    filter(DRUG_GROUP!="DEXAMETHASONE") %>%
    filter(DRUG_GROUP!="FLUCONAZOLE") %>% 
    filter(DRUG_GROUP!="NOT CHEMO") %>% 
    filter(DRUG_GROUP!="NOT MATCHED") %>% 
    filter(DRUG_GROUP!="TRIAL") %>% 
    filter(DRUG_GROUP!="HYDROCORTISONE")

ovariansurgerycohort %>% 
  count(PSEUDO_PAT) #n=16,523 patients in total

ovariansurgerycohort<-ovariansurgerycohort %>% #Then filter only patients who had carboplatin and paclitaxel
  group_by(PSEUDO_PAT) %>% 
  mutate(CARBOPLATINFLAG=ifelse(str_detect(DRUG_GROUP, "CARBOPLATIN"),1,NA)) %>% 
  mutate(PACLITAXELFLAG=ifelse(str_detect(DRUG_GROUP, "PACLITAXEL"),1,NA)) %>% 
  fill(CARBOPLATINFLAG, .direction="updown") %>% 
  fill(PACLITAXELFLAG, .direction="updown") %>% 
  filter(CARBOPLATINFLAG==1) %>% 
  filter(PACLITAXELFLAG==1) %>% 
  ungroup() %>% 
  select(-CARBOPLATINFLAG, -PACLITAXELFLAG)

ovariansurgerycohort %>% 
    count(PSEUDO_PAT) #11,941
```
DO NOT RUN
EXCLUDED AS I DONT THINK THIS WILL AFFECT THE RESULTS AND IS NEEDLESSLY EXCLUDING PATIENTS
n=11,941 patients before this exclusion
2: If patient had any treatment before 2014, remove them as this interferes with the labeling of lines of therapy
N=1,939 excluded
n=10,002 after
```{r}
#ovariansurgerycohort %>% 
#  count(PSEUDO_PAT) #n=11,941 patients
#
#ovariansurgerycohort<-ovariansurgerycohort %>% 
#  mutate(studyperiodexclusion=ifelse(ADMINISTRATION_DATE<"2014-01-01",1,NA)) %>% 
#  group_by(PSEUDO_PAT) %>% 
#  fill(studyperiodexclusion, .direction="updown") %>% 
#  filter(is.na(studyperiodexclusion))
#
#ovariansurgerycohort %>% 
#  count(PSEUDO_PAT) #n=10,002 patients
```

n=11,941 before
Calculate time from diagnosis to first SACT and exclude those not treated within 90 days. This is the expected time frame based on Shibani's comment.
n=10,027 after
n=1,914 excluded
```{r}
ovariansurgerycohort %>%
  count(PSEUDO_PAT) #n=11,941


ovariansurgerycohort<-ovariansurgerycohort %>%
  group_by(PSEUDO_PAT) %>% 
  mutate(DIAGNOSISDATEBEST=dmy(DIAGNOSISDATEBEST)) %>% 
  mutate(ADMINISTRATION_DATE=as.Date(ADMINISTRATION_DATE)) %>% 
  mutate(diagnosistotreat=as.numeric(difftime(min(ADMINISTRATION_DATE),DIAGNOSISDATEBEST,units="days")))

ovariansurgerycohort<-ovariansurgerycohort %>%
 filter(diagnosistotreat<91)

ovariansurgerycohort %>%
  count(PSEUDO_PAT) #n=10,027
```

n=10,027 before
2F: Exclude patients who have a record of SACT AFTER death:
n=5 excluded 
n=10,022 after
```{r}
ovariansurgerycohort %>%
count(PSEUDO_PAT)#n=10,027

ovariansurgerycohort<-ovariansurgerycohort %>%
  mutate(VITALSTATUSDATE=dmy(VITALSTATUSDATE)) %>% 
  select(ADMINISTRATION_DATE,VITALSTATUSDATE,VITALSTATUS,PSEUDO_PAT) %>% 
   filter(ADMINISTRATION_DATE>VITALSTATUSDATE)%>%
   filter(str_detect(VITALSTATUS,"D"))%>%
   distinct(PSEUDO_PAT)%>%
   mutate(exclude=1)%>%
   distinct(PSEUDO_PAT,.keep_all=T)%>%
   select(PSEUDO_PAT, exclude)%>%
   right_join(ovariansurgerycohort, by = "PSEUDO_PAT") %>%
   filter(is.na(exclude))

ovariansurgerycohort %>%
count(PSEUDO_PAT) #n=10,022
```

2bi: Bring in HES records of chemo to incorporate any additional chemotherapy that is not recorded in SACT:
```{r}
cohortlist<-ovariansurgerycohort %>% 
  distinct(PSEUDO_PAT) #create list of patients in the cohort

cohort_dates<-ovariansurgerycohort %>% 
  distinct(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
  mutate(marker="SACT") #mark SACT dataset records

HES_dates<-HES_chemo %>% 
  mutate(APPTDATE=dmy(APPTDATE)) %>% 
  distinct(PSEUDO_PAT,APPTDATE) %>% 
  rename(ADMINISTRATION_DATE=APPTDATE) %>% 
  mutate(marker="HES") # mark HES dataset records

ovariansurgerycohort<-rbind(cohort_dates,HES_dates) %>% #create list of all SACT and HES dates for all patients 
  merge(cohortlist,by="PSEUDO_PAT") %>% #link to included patients
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE,marker) %>% 
  pivot_wider(values_from = marker, names_from = marker) %>% #pivot marker for HES and SACT
  left_join(ovariansurgerycohort, by = c("PSEUDO_PAT","ADMINISTRATION_DATE")) %>% #Join the cohort and bring in new administration dates
  group_by(PSEUDO_PAT) %>% 
  fill(PSEUDO_PAT, .direction="updown") %>% 
  fill(bevflag, .direction="updown") %>% 
  fill(MONTH_DOB, .direction="updown") %>% 
  fill(YEAR_DOB, .direction="updown") %>% 
  fill(SEX, .direction="updown") %>% 
  fill(ETHNICITY, .direction="updown") %>% 
  fill(ETHNICITYNAME, .direction="updown") %>% 
  fill(VITALSTATUS, .direction="updown") %>% 
  fill(VITALSTATUSDATE, .direction="updown") %>% 
  fill(DIAGNOSISDATEBEST, .direction="updown") %>% 
  fill(AGE, .direction="updown") %>% 
  fill(SITE_ICD10_O2, .direction="updown") %>% 
  fill(SITE_CODED, .direction="updown") %>% 
  fill(SITE_CODED_DESC, .direction="updown") %>% 
  fill(HISTOLOGY_CODED, .direction="updown") %>% 
  fill(HISTOLOGY_CODED_DESC, .direction="updown") %>% 
  fill(STAGE_BEST_CLEAN, .direction="updown") %>% 
  fill(FIGO__CLEAN, .direction="updown") %>% 
  fill(PRIMARY_DIAGNOSIS, .direction="updown") %>% 
  fill(BMI, .direction="updown") %>% 
  fill(IMD2015_1, .direction="updown") %>% 
  fill(CENTRETYPE, .direction="updown") %>% 
  fill(REGION, .direction="updown") %>% 
  fill(ORGANISATION_CODE_OF_PROVIDER, .direction="updown") %>% 
  ungroup()

```

EXCLUSION: remove patients who have chemo records in HES from more than 3 months before the SACT dataset. This means they had chemo and that the first records are not neessarily first line treatment:
m=n=10,022 before
n=9,893 after
n=129 excluded because first chemo is in HES and treatment data not given
2biii:  Need to adjust for chemo that is not related to the SACT record:
```{r}
ovariansurgerycohort %>% count(PSEUDO_PAT)#n=n=10,022

cohort_dates<-cohort_dates %>% 
  group_by(PSEUDO_PAT) %>% 
  mutate(sact_first_cycle=min(ADMINISTRATION_DATE)) %>% 
  ungroup()

ovariansurgerycohort<-ovariansurgerycohort %>% 
  group_by(PSEUDO_PAT) %>%
  mutate(firstcycle=min(ADMINISTRATION_DATE)) %>% 
  mutate(record_source=ifelse(is.na(SACT)&(ADMINISTRATION_DATE==firstcycle),"HES","SACT")) %>%
  mutate(hes_record_exclusion=ifelse(record_source=="HES"&lead(record_source)=="SACT", as.numeric(difftime(ADMINISTRATION_DATE, lead(ADMINISTRATION_DATE), units="days")),NA)) %>%  #Calculate time between HES chemotherapy records and SACT chemotherapy records
  mutate(exclusion_first_line=ifelse(hes_record_exclusion<(-90)&!is.na(hes_record_exclusion),1,NA)) %>% 
  fill(exclusion_first_line,.direction="updown") %>% 
  filter(is.na(exclusion_first_line)) %>% ungroup() #Filter out HES chemo records more than 90 days before as this is presumably not related to the first-line therapy

ovariansurgerycohort %>% count(PSEUDO_PAT) #9,893, n=129 excluded
```


2bii: Define lines of therapy. Start with line=1 and flag as new regimen when days between SACT is 120 days or more.
```{r}
ovariansurgerycohort %>%count(PSEUDO_PAT) #n=9,893

ovariansurgerycohort<-ovariansurgerycohort %>% 
  group_by(PSEUDO_PAT) %>% 
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
  distinct(PSEUDO_PAT, ADMINISTRATION_DATE, DRUG_GROUP,.keep_all=T) %>% 
  mutate(DAYSFROMPREVIOUSADMIN=difftime(ADMINISTRATION_DATE, lag(ADMINISTRATION_DATE), units = "days")) %>% 
  mutate(lineoftherapy=row_number()) %>% 
  mutate(lineoftherapy=ifelse(lineoftherapy!=1,NA,lineoftherapy))
  
#Define lines of therapy as per 120 day rule:
linesoftherapy<-ovariansurgerycohort %>% 
  filter(DAYSFROMPREVIOUSADMIN>119|lineoftherapy==1) %>% 
  arrange(PSEUDO_PAT,ADMINISTRATION_DATE) %>% 
  distinct(PSEUDO_PAT, ADMINISTRATION_DATE,lineoftherapy,.keep_all=T) %>%
  select(PSEUDO_PAT, ADMINISTRATION_DATE,lineoftherapy, DAYSFROMPREVIOUSADMIN)%>% 
  mutate(lineoftherapy=row_number())

#Rejoin lines of therapy table to main table:
ovariansurgerycohort<-ovariansurgerycohort %>% 
  left_join(linesoftherapy, by = c("PSEUDO_PAT", "ADMINISTRATION_DATE")) %>% 
  select(-lineoftherapy.x, -DAYSFROMPREVIOUSADMIN.x) %>% 
  rename(lineoftherapy=lineoftherapy.y) %>%
  rename(DAYSFROMPREVIOUSADMIN=DAYSFROMPREVIOUSADMIN.y) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(lineoftherapy,.direction = "down")

ovariansurgerycohort %>%count(PSEUDO_PAT) #n=9,893
```

n=8,534 before this exclusion
Exclude patients who have been labelled with PLD as first-line.
n=1,029 patients excluded
n=8,864 after this exclusion
```{r}
ovariansurgerycohort %>%count(PSEUDO_PAT) #n=9,893

ovariansurgerycohort<-ovariansurgerycohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  arrange(PSEUDO_PAT, lineoftherapy) %>% 
  filter(!str_detect(DRUG_GROUP,"LIPOSOMAL DOXORUBICIN")&lineoftherapy==1) %>% 
  select(PSEUDO_PAT) %>% 
  merge(ovariansurgerycohort, by = "PSEUDO_PAT") 

ovariansurgerycohort %>% count(PSEUDO_PAT) #n=8,864
```

Flag platinum rechallenge where time between carboplatin and treatments are less than 180 days apart.
```{r}
ovariansurgerycohort %>%
  ungroup() %>% 
  count(PSEUDO_PAT) #n=8,864

ovariansurgerycohort<-ovariansurgerycohort %>% 
  mutate(DAYSFROMPREVIOUSADMIN=ifelse(is.na(DAYSFROMPREVIOUSADMIN)|DAYSFROMPREVIOUSADMIN==0,NA,DAYSFROMPREVIOUSADMIN)) %>% 
  group_by(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
    fill(DAYSFROMPREVIOUSADMIN, .direction = "updown") %>% 
  select(PSEUDO_PAT, ADMINISTRATION_DATE, DAYSFROMPREVIOUSADMIN) %>% 
  merge(ovariansurgerycohort, by = c("PSEUDO_PAT", "ADMINISTRATION_DATE")) %>% 
  select(-DAYSFROMPREVIOUSADMIN.y) %>% 
  rename(DAYSFROMPREVIOUSADMIN=DAYSFROMPREVIOUSADMIN.x) %>% 
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
  distinct(PSEUDO_PAT, DRUG_GROUP, ADMINISTRATION_DATE,.keep_all=T) %>% 
  mutate(platinumrechallenge=ifelse(lineoftherapy>1&str_detect(DRUG_GROUP,"CARBOPLATIN|CISPLATIN")&DAYSFROMPREVIOUSADMIN<181,1,NA)) %>% 
  group_by(PSEUDO_PAT, lineoftherapy) %>% 
  fill(platinumrechallenge, .direction = "updown")

ovariansurgerycohort %>%
  ungroup() %>% 
  count(PSEUDO_PAT) #n=8,864
```
################
THIS SECTION LINKS SURGICAL DATA WHERE IT CAN BE FOUND IN HES AND NCRD RECORDS:
2a: Check HES APC for surgery records:
```{r}
cohort<-ovariansurgerycohort %>% 
  ungroup() %>% 
  distinct(PSEUDO_PAT)

ovariansurgerycohort %>% 
  distinct(PSEUDO_PAT) %>% 
  merge(HESAPC,by = "PSEUDO_PAT") %>% 
  count(PSEUDO_PAT)#N=8,793 of 8,864 ovarian patients in the HES APC data out (99.9%)

HESAPC %>%
  filter(str_detect(OPERTN_01, "q|Q")) %>% 
  count(OPERTN_01)

hessurgeries<-HESAPC %>% 
  merge(cohort, by = "PSEUDO_PAT") %>% 
  filter(str_detect(OPERTN_01, "q07|q08|q22|Q07|Q08|Q22")) #Q07/Q08 hysterectomy, Q22 bilateral salpingoophrectomy

hessurgeries %>% 
  count(PSEUDO_PAT)#N=5,240 patients with records of SURGERY in HES (of the 7,731 total ovarian after exclusions)

hessurgeries<-hessurgeries %>% 
  select(PSEUDO_PAT, OPERTN_01, ADMIDATE,OPDATE_01) %>% 
  arrange(PSEUDO_PAT, ADMIDATE) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  mutate(ADMIDATE=dmy(ADMIDATE)) %>% 
  mutate(OPDATE_01=dmy(OPDATE_01))

```

2b:Link surgical information from the NCRD treatments table:
```{r}
ovariansurgerycohort %>%
  ungroup() %>% 
  count(PSEUDO_PAT) #n=8,864 patients in total in the cohort after exclusions

#Define surgeries that are relevant from NCRAS
treatment_table %>% 
  merge(cohort,by="PSEUDO_PAT") %>% 
  filter(str_detect(EVENTDESC,"Surgery|surgery")) %>% 
  filter(str_detect(OPCS4_NAME, "Hysterectomy|hysterectomy|HYSTERECTOMY|Salping|salping|SALPINGOO|Bilateral salp|BILATERAL SALP|bilateral salp")) %>% 
  count(PSEUDO_PAT) #n=5,069/8,864 patients with any surgery recorded by these terms of the 13144 eligible patients have a record in the NCRD data

surgerytableNCRAS<-treatment_table %>% 
  merge(cohort,by="PSEUDO_PAT") %>% 
  filter(str_detect(EVENTDESC,"Surgery|surgery")) %>% 
  filter(str_detect(OPCS4_NAME, "Hysterectomy|hysterectomy|HYSTERECTOMY|Salping|salping|SALPINGOO|Bilateral salp|BILATERAL SALP|bilateral salp")) %>% 
  distinct(PSEUDO_PAT, EVENTDATE,.keep_all=T) #5,240/8,864 patients have a record of surgery in the NCRAS registry

#Merge NCRAS and HES surgery records
surgerytableNCRAS<-surgerytableNCRAS %>% 
  select(PSEUDO_PAT, EVENTDATE, OPCS4_CODE) 

hessurgeries<-hessurgeries %>% 
  select(PSEUDO_PAT, OPDATE_01, OPERTN_01) %>% 
  rename(EVENTDATE=OPDATE_01) %>% 
  rename(OPCS4_CODE=OPERTN_01) %>% 
  arrange(PSEUDO_PAT, EVENTDATE) %>% 
  distinct(PSEUDO_PAT,.keep_all=T)

hessurgeries %>% count(PSEUDO_PAT) #n=5,240 with HES record of hysterectomy/bilateral salpingoophrectomy

allsurgeries<-rbind(surgerytableNCRAS,hessurgeries) %>% 
  distinct(PSEUDO_PAT, EVENTDATE, OPCS4_CODE)

allsurgeries %>% count(PSEUDO_PAT) #n=5,608/8,864 patients with record of hysterectomy or bilateral salpinoophrectomy in the HES or NCRD data combined.
```





N=8,864 before this exclusion
N=5,608 have a record of surgery in HES or NCRD
Filter for patients who receive surgery within 12 months of the study period:
N=4,665 received surgery from 01/01/2013 onwards
N=4,199 had their surgery before the study period and were excluded

After this chunk: N=4,665
```{r}
ovariansurgerycohort %>%ungroup() %>%  count(PSEUDO_PAT)#n=8,864 patients in the cohort

allsurgeries %>% count(PSEUDO_PAT) #n=5,608 patients with record of hysterectomy or bilateral salp

allsurgeries<-allsurgeries %>% 
  mutate(EVENTDATE=dmy(EVENTDATE)) %>% 
  filter(EVENTDATE>"2013-01-01") %>%
  filter(EVENTDATE<"2020-01-01") #exclude patients who do not have a surgery within 1 year of starting SACT within the study period
#Arrange by patient ID and surgery date to keep the first date of hysterectomy/bilateral salpin for each patient.
allsurgeries<-allsurgeries %>% 
  arrange(PSEUDO_PAT, EVENTDATE) %>% 
  distinct(PSEUDO_PAT,.keep_all=T)

allsurgeries %>% 
  count(PSEUDO_PAT) #n=4,665 patients had surgery within study period 

allsurgeries<-allsurgeries %>% 
 filter(!is.na(EVENTDATE)) #Filter patients where there is no surgery date.
      
allsurgeries %>% 
  count(PSEUDO_PAT) #n=4,665, n=0 excluded for having no surgery date
 
ovariansurgerycohort<-allsurgeries %>% 
  merge(ovariansurgerycohort, by ="PSEUDO_PAT")

allsurgeries %>% 
  count(PSEUDO_PAT)#n=4,665 patients with a surgery record link to SACT
```

n=4,665 before
Define time from debulking surgery to adjuvant treatment:
n=231 removed for not having received adjuvant chemo with 90 days of surgery
n=4,434 after excluding patients who do not have adjuvant chemo within 90 days of surgery
```{r}
ovariansurgerycohort %>% count(PSEUDO_PAT) #n=4,665

adjuvanttreatmenttime<-ovariansurgerycohort %>% 
  ungroup() %>% 
  mutate(ADMINISTRATION_DATE=as.Date(ADMINISTRATION_DATE)) %>% 
  mutate(surgerychemotime=as.numeric(difftime(ADMINISTRATION_DATE, EVENTDATE, units = "days"))) %>% 
  filter(!is.na(surgerychemotime)) %>% #removes patients who didn't have surgery
  filter(surgerychemotime<91&surgerychemotime>0) %>%  #removes surgeries more than 3 months before as these are presumed to be related to previous line of treatment
  arrange(PSEUDO_PAT,surgerychemotime) %>% 
  group_by(PSEUDO_PAT) %>% 
  mutate(adjuvantbreak=min(surgerychemotime)) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% #keeps first chemo after surgery
  select(PSEUDO_PAT, adjuvantbreak, surgerychemotime) %>% 
  ungroup()


ovariansurgerycohort<-ovariansurgerycohort %>% 
  merge(adjuvanttreatmenttime, by = "PSEUDO_PAT") 

ovariansurgerycohort %>% count(PSEUDO_PAT)# N=4,434 patients are excluded who did not receive adjuvant treatment with 180 days of surgery
```

Then need to flag PDS or IDS treatment:
```{r}
PDSIDS<-ovariansurgerycohort %>% 
  ungroup() %>% 
  mutate(surgerychemotime=as.numeric(difftime(ADMINISTRATION_DATE, EVENTDATE, units = "days"))) %>% 
  filter(surgerychemotime<91&surgerychemotime>-91) %>%
  mutate(neoadjuvant=ifelse(surgerychemotime<0&surgerychemotime>-91,1,NA)) %>% 
  mutate(adjuvant=ifelse(surgerychemotime>0&surgerychemotime<91,1,NA)) %>% 
  group_by(PSEUDO_PAT) %>% 
  fill(neoadjuvant, .direction = "updown") %>% 
  fill(adjuvant, .direction = "updown") %>% 
  mutate(PDS=ifelse(adjuvant==1&is.na(neoadjuvant),1,NA)) %>% 
  mutate(IDS=ifelse(neoadjuvant==1&adjuvant==1,1,NA)) %>% 
  fill(PDS, .direction = "updown") %>% 
  fill(IDS, .direction = "updown") %>% 
  distinct(PSEUDO_PAT, .keep_all=T) %>%   
  ungroup()

ovariansurgerycohort<-PDSIDS %>% 
  select(PSEUDO_PAT, EVENTDATE, PDS, IDS, neoadjuvant, adjuvant) %>% 
  merge(ovariansurgerycohort, by = "PSEUDO_PAT")

ovariansurgerycohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(PDS,IDS) #n=1,861 patients had PDS only, n=2,573 had IDS

ovariansurgerycohort %>% 
  count(PSEUDO_PAT) #n=4,434 patients in total had surgery within 180 days of adjuvant chemotherapy. This includes htose who had neoadjuvant carbo/taxol chemotherapy before

```

Link trust codes:
```{r}
trust_codes %>% 
  ungroup() %>% 
  skimr::skim() #Commissioning Region and centre type are complete -  this is what we need

ovariansurgerycohort<-trust_codes %>% 
  rename(ORGANISATION_CODE_OF_PROVIDER=Code) %>% 
  mutate(CENTRE_TYPE=ifelse(`Academic hospital`=="Y","Academic","DGH")) %>% 
  select(ORGANISATION_CODE_OF_PROVIDER, `Commissioning region`, CENTRE_TYPE) %>% 
  right_join(ovariansurgerycohort, by = "ORGANISATION_CODE_OF_PROVIDER")

ovariansurgerycohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(CENTRE_TYPE) #1/4,434 missing

ovariansurgerycohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  count(`Commissioning region`)#1/4,434 missing
```

Assign surgical modality as one variable:
```{r}
ovariansurgerycohort<-ovariansurgerycohort %>% 
  mutate(modality=ifelse(!is.na(PDS),"PDS","IDS"))
```


Check data missingness:
```{r}
ovariansurgerycohort %>% 
  ungroup() %>% 
  skimr::skim()
```

Define categories for age, BMI:
```{r}
#Define age categories
 ovariansurgerycohort<- ovariansurgerycohort %>% 
  mutate(AGE=as.numeric(AGE))
ovariansurgerycohort$AGECATEGORY<-cut(ovariansurgerycohort$AGE, breaks=c(0,60,70,150), right = FALSE)
#Define BMI categories
ovariansurgerycohort<-ovariansurgerycohort %>% 
mutate(BMI=as.numeric(BMI))
ovariansurgerycohort$BMI2<-cut(ovariansurgerycohort$BMI, breaks=c(0,18.5, 25, 30, 40, 100), right = FALSE)
ovariansurgerycohort$BMI2<- relevel(ovariansurgerycohort$BMI2, ref = "[18.5,25)")
ovariansurgerycohort$modality<-as.factor(ovariansurgerycohort$modality)
ovariansurgerycohort$modality<- relevel(ovariansurgerycohort$modality, ref = "PDS")
ovariansurgerycohort$ETHNICITYNAME<-as.factor(ovariansurgerycohort$ETHNICITYNAME)
ovariansurgerycohort<- ovariansurgerycohort %>% 
  mutate(ETHNICITYCATEGORY=ifelse(ETHNICITYNAME=="WHITE","White", "Non-white"))
ovariansurgerycohort$ETHNICITYNAME<- relevel(ovariansurgerycohort$ETHNICITYNAME, ref = "WHITE BRITISH")
```



```{r}
ovariansurgerycohort %>% write_csv("surgery_final_cohort_08OCT24.csv")

ovariansurgerycohort %>%
  count(PSEUDO_PAT) #n=4,434
```

Define surgery to adjuvant treatment time and fill for each patient. 
Assign time categories for each patient as per upgrade report protocol (<4 weeks, 4-6 weeks, 6-8 weeks, 8< weeks)
```{r}
#Define categories into <4 weeks, 4-6 weeks, 6-8 weeks, 8<weeks
ovariansurgerycohort<-ovariansurgerycohort %>% 
  mutate(adjuvantbreak=as.numeric(adjuvantbreak))

ovariansurgerycohort$adjuvantbreakcategory<-cut(ovariansurgerycohort$adjuvantbreak, breaks=c(0,43,181), right = FALSE)
```

```{r}
ovariansurgerycohort %>% write_csv("surgery_final_cohort_08OCT24.csv")
```

As per David's comments, a frailty score can be constructed using HES diagnostic codes.
This uses the SCARF methodology which been published and validated after being used in the breast cancer audit NABCOP. 
ICD10 codes for frailty as per Gilbert et al 2018: https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(18)30668-8/fulltext
```{r}
#Read in the ovarian cohort for ease of use:
ovariansurgerycohort <- read_csv(
  "surgery_final_cohort_08OCT24.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)
#ovariansurgerycohort$PS<-cut(ovariansurgerycohort$PS, breaks=c(0,1,2,10), right = FALSE)
ovariansurgerycohort$ETHNICITYNAME<-as.factor(ovariansurgerycohort$ETHNICITYNAME)

ovariansurgerycohort$ETHNICITYNAME<- relevel(ovariansurgerycohort$ETHNICITYNAME, ref = "WHITE BRITISH")
#Create  list of included patients:
filterlist<-ovariansurgerycohort %>% 
  distinct(PSEUDO_PAT)
#Import HES APC records:
#HESDIAGNOSIS1<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG2122_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS2<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG2021_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS3<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1920_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS4<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1819_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS5<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1718_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS6<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1617_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS7<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1516_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS8<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1415_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS9<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1314_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS10<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1213_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS11<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1112_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESDIAGNOSIS12<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESAPC_DIAG1011_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
##Import HES OP records
#HESOPDIAGNOSIS1<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG2122_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS2<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG2021_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS3<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1920_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS4<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1819_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS5<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1718_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL) %>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS6<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1617_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS7<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1516_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS8<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1415_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS9<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1314_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS10<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1213_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS11<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1112_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#HESOPDIAGNOSIS12<-read_csv(
#  "K://QNAP//BRCT//SACT project//LSanalysis//Rstudio//HES data link//ODR1920_080_HESOP_DIAG1011_2019Data.csv",
#  col_names = TRUE,
#  col_types = cols(.default = col_character()),
#  col_select = NULL)%>% 
#  merge(filterlist, by = "PSEUDO_PAT")
##Join HES APC data and write.csv
#HES_all_data_bind1<-rbind(HESDIAGNOSIS1,HESDIAGNOSIS2)
#HES_all_data_bind2<-rbind(HESDIAGNOSIS3,HESDIAGNOSIS4)
#HES_all_data_bind3<-rbind(HESDIAGNOSIS5,HESDIAGNOSIS6)
#HES_all_data_bind4<-rbind(HESDIAGNOSIS7,HESDIAGNOSIS8)
#HES_all_data_bind5<-rbind(HESDIAGNOSIS9,HESDIAGNOSIS10)
#HES_all_data_bind6<-rbind(HESDIAGNOSIS11,HESDIAGNOSIS12)
#HES_bind12<-rbind(HES_all_data_bind1,HES_all_data_bind2)
#HES_bind34<-rbind(HES_all_data_bind3,HES_all_data_bind4)
#HES_bind56<-rbind(HES_all_data_bind5,HES_all_data_bind6)
#HES_APC_data<-rbind(HES_bind12, HES_bind34,HES_bind56) %>% arrange(PSEUDO_PAT, DATAYEAR)
#HES_APC_data#n=XXXX, %% of total of 6,536 patients
#rm(HES_all_data_bind1,HES_all_data_bind2,HES_all_data_bind3,HES_all_data_bind4,HES_all_data_bind5,HES_all_data_bind6)
#rm(HESDIAGNOSIS1,HESDIAGNOSIS2,HESDIAGNOSIS3,HESDIAGNOSIS4,HESDIAGNOSIS5,HESDIAGNOSIS6,HESDIAGNOSIS7,HESDIAGNOSIS8,HESDIAGNOSIS9,HE#SDIAGNOSIS10,HESDIAGNOSIS11,HESDIAGNOSIS12)
#rm(HES_bind12,HES_bind34,HES_bind56)
#HES_APC_data<-HES_APC_data%>% 
#  select(PSEUDO_PAT, DATAYEAR, DIAG4_01:DIAG4_12) 
#HES_APC_data%>% 
#  write_csv("HES_APC_DIAG_23OCT24.csv")
#HES_APC_data%>% 
#  count(PSEUDO_PAT)#n=4442 of 6536
#save(HES_APC_data, "HES_APC_data.rda")
#```
#
#
#```{r}
#load()
##Bind HES OP and write full file:
#HESOPDIAGNOSIS12<-rbind(HESOPDIAGNOSIS1,HESOPDIAGNOSIS2)
#HESOPDIAGNOSIS34<-rbind(HESOPDIAGNOSIS3,HESOPDIAGNOSIS4)
#HESOPDIAGNOSIS56<-rbind(HESOPDIAGNOSIS5,HESOPDIAGNOSIS6)
#HESOPDIAGNOSIS78<-rbind(HESOPDIAGNOSIS7,HESOPDIAGNOSIS8)
#HESOPDIAGNOSIS910<-rbind(HESOPDIAGNOSIS9,HESOPDIAGNOSIS10)
#HESOPDIAGNOSIS1112<-rbind(HESOPDIAGNOSIS11,HESOPDIAGNOSIS12)
#HES_apocoperbind12<-rbind(HESOPDIAGNOSIS12,HESOPDIAGNOSIS34)
#HES_apocoperbind34<-rbind(HESOPDIAGNOSIS56,HESOPDIAGNOSIS78)
#HES_apocoperbind56<-rbind(HESOPDIAGNOSIS910,HESOPDIAGNOSIS1112)
#HES_OP_data<-rbind(HES_apocoperbind12, HES_apocoperbind34,HES_apocoperbind56) %>% arrange(PSEUDO_PAT, DATAYEAR)
#rm(HES_apocoperbind12,HES_apocoperbind34,HES_apocoperbind56)
#rm(HESOPDIAGNOSIS1,HESOPDIAGNOSIS2,HESOPDIAGNOSIS3,HESOPDIAGNOSIS4,HESOPDIAGNOSIS5,HESOPDIAGNOSIS6,HESOPDIAGNOSIS7,HESOPDIAGNOSIS8,#HESOPDIAGNOSIS9,HESOPDIAGNOSIS10,HESOPDIAGNOSIS11,HESOPDIAGNOSIS12)
#
#HES_OP_data<-HES_OP_data%>% 
#  select(PSEUDO_PAT, DATAYEAR, DIAG4_01:DIAG4_12) %>% 
#  merge(filterlist, by = "PSEUDO_PAT")
#
#HES_OP_data %>% 
#  write.csv("HES_OP_DIAG_23OCT24.csv")
#
#HES_OP_data%>% 
#  count(PSEUDO_PAT)#n=XXX of 6536 
#
##Then merge the OP and APC data
#all_hes_data<-rbind(HES_OP_data, HES_APC_data) %>% 
# arrange(PSEUDO_PAT,DATAYEAR) %>% 
#  ungroup()
#
#all_hes_data %>% 
#  write_csv("all_hes_data_OP_and_APC.csv")
```

Read in HES data:
```{r}
all_hes_data<-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Rstudio\\Surgery to adjuvant treatment\\all_hes_data_OP_and_APC.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)
```



Write csv for quicker use:
```{r}
ovariansurgerycohort %>% 
  write_csv("surgery_final_cohort_4NOV24.csv")
```

Read csv:
```{r}
ovariansurgerycohort <-read_csv(
  "K:\\QNAP\\BRCT\\SACT project\\LSanalysis\\Thesis Chapters\\Chapter 7 - Time to adjuvant chemotherapy\\surgery_final_cohort_4NOV24.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)

ovariansurgerycohort %>% 
  count(PSEUDO_PAT)#n=4,002

codes<-ovariansurgerycohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% #N=4,434
  select(PSEUDO_PAT, ORGANISATION_CODE_OF_PROVIDER)
```


Set index dates:
According to Timmermans et al, use primary surgery date as index for PDS and first chemo for IDS:
Interval between debulking surgery and adjuvant chemotherapy is associated with overall survival in patients with advanced ovarian cancer
```{r}
cohort<-ovariansurgerycohort %>% 
  mutate(VITALSTATUSDATE=dmy(VITALSTATUSDATE)) 

#cohort<-cohort %>% 
#  group_by(PSEUDO_PAT) %>% 
#  mutate(time=difftime(ADMINISTRATION_DATE, EVENTDATE.x, units = "days")) %>% 
#  filter(time>0) %>% 
#  arrange(PSEUDO_PAT, time) %>% 
#  mutate(time2=min(time)) %>% 
#  filter(time==time2) %>% 
#  distinct(PSEUDO_PAT,.keep_all=T) %>% 
#  mutate(INDEX=ADMINISTRATION_DATE) %>% 
#  select(PSEUDO_PAT, INDEX) %>% 
#  merge(cohort,by="PSEUDO_PAT")

cohort %>%
  count(PSEUDO_PAT)#n=4,002

cohort2<-cohort %>% 
  group_by(PSEUDO_PAT) %>%
  mutate(EVENTDATE=as.Date(EVENTDATE.x)) %>% 
  mutate(surgerychemotime=as.numeric(surgerychemotime)) %>% 
  mutate(ADMINISTRATION_DATE=as.Date(ADMINISTRATION_DATE)) %>% 
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>% 
  mutate(INDEX=as.Date(ifelse(modality=="PDS",min(ADMINISTRATION_DATE),EVENTDATE+surgerychemotime)))#PDS - set index date as surgery, IDS set index date as first neoadjuvant chemotherapy as per Timmermans et al.


cohort2 %>% 
  distinct(PSEUDO_PAT,.keep_all = T) %>% 
  select(PSEUDO_PAT, modality, EVENTDATE, INDEX,surgerychemotime, ADMINISTRATION_DATE)
```

Check PDS and IDS have been properly assigned to all patients:
```{r}
cohort<-cohort2 %>% 
  distinct(PSEUDO_PAT,.keep_all=T) #n=4,434 patients in the analysis cohort1

cohort%>% 
  ungroup() %>% 
  count(modality) #no patients with no assigned surgical strategy. n=2,573 IDS, n=1,861 PDS
```

Link the bevacizumab flag to incoporate into survival analysis:
```{r}
cohort<-bevflagtable %>% 
  merge(cohort, by= "PSEUDO_PAT")

cohort<-cohort %>%
  rename(bevflag=bevflag.x) %>% 
  mutate(bevflag=ifelse(is.na(bevflag),0,bevflag))
```



Create 5-year overall survival outcome from surgery or first treatment date to last known follow up:
```{r}
cohort<-cohort %>% 
  #mutate(ADMINISTRATION_DATE=as.character(ADMINISTRATION_DATE)) %>% 
  group_by(PSEUDO_PAT) %>% 
  arrange(PSEUDO_PAT, ADMINISTRATION_DATE) %>%
  mutate(overall_survival=as.numeric(difftime(VITALSTATUSDATE, INDEX, units = "days"))) %>% 
  mutate(EVENT=ifelse(overall_survival<1826&VITALSTATUS=="D",1,0)) %>% 
  #mutate(overall_survival=ifelse(is.na(overall_survival),1826,overall_survival)) %>% 
  mutate(EVENT=ifelse(is.na(EVENT),0,EVENT)) %>% 
  #mutate(overall_survival=ifelse(is.na(overall_survival), 1825, overall_survival)) %>% 
  select(PSEUDO_PAT, overall_survival, EVENT) %>% 
  merge(cohort, by = "PSEUDO_PAT")

cohort<-cohort %>% 
  distinct(PSEUDO_PAT,.keep_all=T)

cohort %>% 
  count(EVENT) #n=2,468/4,434 patients died within 5 years. n=1,966 survived beyond 5 years. 

```

Describe pattern of missingness of BMI:
Create histograms:
```{r}
missing_data<-cohort %>% 
  ungroup() %>% 
  mutate(BMI=as.numeric(BMI))

skimr<-missing_data %>% 
  skimr::skim()

skimr_nhs_site<-missing_data %>% 
  rename(`Treating centre`=ORGANISATION_CODE_OF_PROVIDER) %>% 
  group_by(`Treating centre`) %>% 
  skimr::skim() %>% 
  filter(skim_variable=="BMI") %>% 
  mutate(complete_rate=(complete_rate*100))

skimr%>% 
  write_csv("data_missingness_study3.csv")

skimr_nhs_site%>% 
  write_csv("BMI_missingness_bynhssite_study3.csv")


skimr_nhs_site %>% 
  arrange(complete_rate)


 ggplot(skimr_nhs_site, aes(y  = complete_rate, fill = "Treating centre")) +
 geom_histogram() +scale_y_continuous(seq(0:100))+ggtitle("Completeness of BMI") +labs(x="Number of sites",y="completeness")+theme(plot.title = element_text(hjust=0.5))+labs(y="%")
```
#Import cycle tables containing PS
```{r}
cohort %>% 
  select(PS) %>% 
  skimr::skim()

#load origina tables containing PS
load("SACTCYCLENEW_2019.rda")

SACTCYCLEOLD_2019<-read_csv(
 "K:/QNAP/BRCT/SACT project/LSanalysis/Rstudio/ODR1920_080 SACTCYCLEOLD_2019Data.csv",
  col_names = TRUE,
  col_types = cols(.default = col_character()),
  col_select = NULL)

load("SACTREGIMENNEW_2019.rda")
load("SACTREGIMENOLD_2019.rda")
load("SACTTUMOURNEW_2019.rda")
load("SACTTUMOUROLD_2019.rda")

#Merge with tumour table to link PSEUDO_PAT
PS_new<-SACTTUMOURNEW_2019 %>% 
  merge(SACTCYCLENEW_2019,by=c("PSEUDO_PAT","PSEUDO_ENCORE_TUMOUR_ID")) %>% 
  filter(!is.na(PS)) %>% 
  select(PSEUDO_PAT,PSEUDO_ENCORE_TUMOUR_ID,PS) %>% 
  rename(PSEUDO_TUMOURID=PSEUDO_ENCORE_TUMOUR_ID)

PS_OLD<-SACTTUMOUROLD_2019 %>% 
  merge(SACTCYCLEOLD_2019,by=c("PSEUDO_MERGED_PATIENT_ID","PSEUDO_MERGED_TUMOUR_ID")) %>% 
  filter(!is.na(PERF_STAT_START_OF_CYCLE_CLEAN)) %>% 
  select(PSEUDO_PAT,PSEUDO_TUMOURID,PERF_STAT_START_OF_CYCLE_CLEAN) %>% 
  rename(PS=PERF_STAT_START_OF_CYCLE_CLEAN)

#Bind all PS data
PS_all<-rbind(PS_new,PS_OLD) %>% 
mutate(PS=as.numeric(PS))

#Take the mean  PS for each TUMOURID as this will choose the most commonly assigned PS during the patient's treatment
PS_all<-PS_all %>% 
group_by(PSEUDO_PAT, PSEUDO_TUMOURID) %>% 
  mutate(PS=mean(PS)) %>% 
  ungroup()

#Round to nearest whole number
PS_all$PS<-  round(PS_all$PS)

#Keep value for each PSEUDO_TUMOURID
PS_all<-PS_all %>% 
  distinct(PSEUDO_PAT, PSEUDO_TUMOURID,.keep_all=T)

#Merge available PS to the dataset:
cohort<-cohort %>% 
  left_join(PS_all, by = c("PSEUDO_PAT", "PSEUDO_TUMOURID")) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  select(-PS.x) %>% 
  rename(PS=PS.y)


cohort %>% 
  select(PS) %>% 
  summary()

cohort<-cohort %>% 
  #mutate(PS=as.numeric(PS)) %>% 
  #filter(!is.na(PS)) %>% #n=3414 for complete case analysis
  mutate(PS=ifelse(PS>1,2,PS))


cohort<-cohort %>% 
  mutate(STAGE_BEST_CLEAN=ifelse(str_detect(STAGE_BEST_CLEAN, "2"),"2",STAGE_BEST_CLEAN)) %>% 
  mutate(STAGE_BEST_CLEAN=ifelse(str_detect(STAGE_BEST_CLEAN, "3"),"3",STAGE_BEST_CLEAN)) %>% 
  mutate(STAGE_BEST_CLEAN=ifelse(str_detect(STAGE_BEST_CLEAN, "4"),"4",STAGE_BEST_CLEAN))

cohort %>% 
  select(PS) %>% 
  skimr::skim() #PS 91.95% complete
```

MICE: Select variables for multiple imputation. This is to impute the BMI and PS values for patients with missing height and weight data, to incorprate into survival analysis. 
MICE must include the outcome as part of the imputation model.
PS is now part of this model as per David's suggestion:
Select variables for imputation:
```{r}
imputationdataset <-cohort %>%
  mutate(BMI=as.numeric(BMI)) %>% 
  distinct(PSEUDO_PAT,.keep_all=T) %>% 
  select(PSEUDO_PAT,modality, REGION, CENTRE_TYPE,ETHNICITYNAME,BMI,IMD2015_1,PS, AGECATEGORY,bevflag,STAGE_BEST_CLEAN, overall_survival, EVENT)

imputationdataset %>% 
  skimr::skim() #BMI 98.3% complete, PS 91.9% complete

#These data will be imputed to allow for improved survival analysis
```

Multiple imputation of missing data:
```{r}
tempData <- mice(imputationdataset,m=20,maxit=20,meth='pmm')
summary(tempData)

tempData$imp$BMI #Checks imputed data for a specified variable
summary(tempData$imp$BMI)
completedData <- complete(tempData,1) #Completes the dataset with imputed data

completedData %>% 
  skimr::skim()
```

Then check the distribution of imputed BMI data to the observed:
```{r}
xyplot(tempData,~ BMI,pch=18,cex=1) #this code shows the distribution of imputed values against observed values
xyplot(tempData,~ PS,pch=18,cex=1) #this code shows the distribution of imputed values against observed values

densityplot( x=tempData , data= tempData~BMI)#this code will plot a histogram of the imputed data against the observed data
densityplot( x=tempData , data= tempData~PS)#this code will plot a histogram of the imputed data against the observed data

```

Relink ethnicity and IMD as some of these data were lost in linkage:
Rejoin to original table:
```{r}
#demographic_table %>% 
#  distinct(PSEUDO_PAT,.keep_all=T) %>% 
#  merge(cohort,by="PSEUDO_PAT") %>% 
#  select(ETHNICITYNAME.x,ETHNICITYNAME.y) %>% 
#  skimr::skim()
#
#cohort %>% 
#  skimr::skim()
#
#cohort %>% 
#  group_by(PSEUDO_PAT) %>% 
#  fill(ETHNICITYNAME,.direction="updown") %>% 
#  select(ETHNICITYNAME) %>% 
#  ungroup() %>% 
#  skimr::skim()
```


Rename to completed dataset to cohort for analysis:
```{r}
cohort<-cohort %>% 
  select(-BMI,-PS)#Remove BMI and PS  from the cohort

cohort2<-completedData %>% 
  select(PSEUDO_PAT, BMI,PS) %>% #Link imputed BMI and PS values
  merge(cohort, by= "PSEUDO_PAT")

imputationdataset %>% 
  skimr::skim()

completedData %>% 
  skimr::skim()

cohort2$BMI2<-cut(cohort2$BMI, breaks=c(0,18.5, 25, 30, 40, 100), right = FALSE)
cohort2$PS<-cut(cohort2$PS, breaks=c(0,1,2,10), right = FALSE)

cohort<-cohort2

cohort2%>% 
  ungroup() %>% 
  skimr::skim()
```

Describe pattern of missingness of PS:
Create histograms:
```{r}
missing_data2<-cohort2 %>% 
  ungroup()

skimr_PS_by_site<-missing_data2 %>% 
  rename(`Treating centre`=ORGANISATION_CODE_OF_PROVIDER) %>% 
  group_by(`Treating centre`) %>% 
  skimr::skim() %>% 
  filter(skim_variable=="PS") %>% 
  mutate(complete_rate=(complete_rate*100))

skimr_PS_by_site%>% 
  write_csv("PS_missingness_bynhssite_study3.csv")


skimr_PS_by_site %>% 
  arrange(complete_rate)


 ggplot(skimr_PS_by_site, aes(y  = complete_rate, fill = "Treating centre")) +
 geom_histogram() +scale_y_continuous(seq(0:100))+ggtitle("Completeness of performance status") +labs(x="Number of sites",y="completeness")+theme(plot.title = element_text(hjust=0.5))+labs(y="%")
```
Recode ethnicity for analysis:
```{r}
cohort3<-cohort2 %>% 
 mutate(ethnicitygroup=ifelse(str_detect(ETHNICITYNAME,"WHITE"),"White","Non-white")) %>% 
  mutate(ETHNICITY2=ifelse(str_detect(ETHNICITYNAME, "WHITE"),"White",NA)) %>% 
  mutate(ETHNICITY2=ifelse(str_detect(ETHNICITYNAME, "ASIAN|BLACK|CHINESE"),"Asian/Black",ETHNICITY2)) %>% 
  mutate(ETHNICITY2=ifelse(str_detect(ETHNICITYNAME, "OTHER|UNKNOWN|MIXED|NOT STATED|NOT KNOWN|Unknown"),"Mixed Race/Other/Unknown",ETHNICITY2))
```

Create table one by surgical status:
```{r}
cohort<-cohort3

completecase<-cohort %>% 
  filter(!is.na(PS)) %>% 
 select(PSEUDO_PAT,modality,STAGE_BEST_CLEAN, adjuvantbreak, adjuvantbreakcategory,overall_survival,EVENT,PS, bevflag, BMI,BMI2, ETHNICITY2,ethnicitygroup, AGECATEGORY,AGE,AGECATEGORY, IMD2015_1, `Commissioning region`, CENTRE_TYPE)

cohort<-cohort %>% 
 select(PSEUDO_PAT,modality,STAGE_BEST_CLEAN, adjuvantbreak, adjuvantbreakcategory,overall_survival,EVENT,PS, bevflag, BMI,BMI2, ETHNICITY2,ethnicitygroup, AGECATEGORY,AGE,AGECATEGORY,  IMD2015_1, `Commissioning region`, CENTRE_TYPE) %>% 
  mutate(adjuvantbreak=as.numeric(adjuvantbreak)) %>% 
    mutate(AGE=as.numeric(AGE))

tableone<-cohort%>% 
  select(-PSEUDO_PAT) %>% 
  tbl_summary(by="modality",missing_text="(Missing)") %>% 
  add_p() %>% 
  add_n() %>% 
  add_overall()

tableone%>%
  as_gt() %>% 
  gt::gtsave("tableone.docx")
```


Outcome 1a: Comparison of median time from surgery to adjuvant chemotherapy by ethnicity:
```{r}
library(gtsummary)
ethnicity<-cohort %>% 
 select(modality,STAGE_BEST_CLEAN, adjuvantbreak, adjuvantbreakcategory,overall_survival,EVENT,bevflag,PS, BMI,BMI2, ETHNICITY2,ethnicitygroup, AGECATEGORY,AGE, IMD2015_1, `Commissioning region`, CENTRE_TYPE) %>% 
  tbl_summary(by="ETHNICITY2") %>% 
  add_p() %>% 
  add_n() %>% 
  add_overall()

ethnicity%>%
  as_gt() %>% 
  gt::gtsave("adjuvanttimebyethnicity.docx")

ethnicity_CATEGORY<-cohort %>% 
 select(modality,STAGE_BEST_CLEAN, adjuvantbreak, adjuvantbreakcategory,overall_survival,EVENT,bevflag,PS, BMI,BMI2, ETHNICITY2,ethnicitygroup, AGECATEGORY,AGE, IMD2015_1, `Commissioning region`, CENTRE_TYPE) %>% 
  tbl_summary(by="ethnicitygroup") %>% 
  add_p() %>% 
  add_n() %>% 
  add_overall()

ethnicity_CATEGORY%>%
  as_gt() %>% 
  gt::gtsave("adjuvanttimebyethnicity_category.docx")
```

Outcome 1b: Comparison of median time from surgery to adjuvant chemotherapy by age category:
```{r}
age<-cohort %>% 
 select(modality,STAGE_BEST_CLEAN, adjuvantbreak, adjuvantbreakcategory,overall_survival,EVENT,bevflag,PS, BMI,BMI2, ETHNICITY2,ethnicitygroup, AGECATEGORY,AGE, IMD2015_1, `Commissioning region`, CENTRE_TYPE) %>% 
  tbl_summary(by="AGECATEGORY") %>% 
  add_p() %>% 
  add_n() %>% 
  add_overall()

age%>%
  as_gt() %>% 
  gt::gtsave("adjuvanttimebyage.docx")
```

Outcome 1c: Comparison of median time from surgery to adjuvant chemotherapy by IMD:
```{r}
imd<-cohort %>% 
  ungroup() %>% 
 select(modality,STAGE_BEST_CLEAN, adjuvantbreak, adjuvantbreakcategory,overall_survival,EVENT,bevflag,PS, BMI,BMI2, ETHNICITY2,ethnicitygroup, AGECATEGORY,AGE, IMD2015_1, `Commissioning region`, CENTRE_TYPE) %>% 
  tbl_summary(by="IMD2015_1") %>% 
  add_p() %>% 
  add_n() %>% 
  add_overall()

imd%>%
  as_gt() %>% 
  gt::gtsave("adjuvanttimebyIMD.docx")
```

Outcome 1d: Compare time to surgery by region:
```{r}
region<-cohort %>% 
   ungroup() %>% 
 select(modality,STAGE_BEST_CLEAN, adjuvantbreak, adjuvantbreakcategory,overall_survival,EVENT,bevflag,PS, BMI,BMI2, ETHNICITY2,ethnicitygroup, AGECATEGORY,AGE, IMD2015_1, `Commissioning region`, CENTRE_TYPE) %>% 
  tbl_summary(by=`Commissioning region`) %>% 
  add_p() %>% 
  add_n() %>% 
  add_overall()

region%>%
  as_gt() %>% 
  gt::gtsave("adjuvanttimebyregion.docx")
```

Index date is the first treatment after chemo for PDS and IDS patients.

Outcome 2: 5-year survival relative to adjuvant treatment period:
Outcome: death by any cause within 5 years of primary debulking surgery OR first neoadjuvant chemotherapy if IDS
The exposure is adjuvant treatment time. 
Explanatory variables are AGE, BMI (binned), stage, ethnicity, region, centre type and comorbidity.
```{r}
cohortsurvival<-cohort %>% 
  rename(Region=`Commissioning region`) %>% 
  mutate(bevflag=ifelse(is.na(bevflag),0,bevflag))


cohortsurvival %>% 
  count(EVENT) #n=2,182 die within 5 years, n=1,820 survive 5 years or longer

cohortsurvival %>% 
 select(overall_survival, adjuvantbreak) %>% 
  summary() #median adjuvant break was 39 days (IQR-30-49 days, range 3-90 days)
cohortsurvival$modality<-as.factor(cohortsurvival$modality)

cohortsurvival$modality<- relevel(cohortsurvival$modality, ref = "PDS")

cohortsurvival$ETHNICITY2<-as.factor(cohortsurvival$ETHNICITY2)

cohortsurvival$BMI2<-as.factor(cohortsurvival$BMI2)
cohortsurvival$BMI2<- relevel(cohortsurvival$BMI2, ref = "[18.5,25)")

cohortsurvival$bevflag<-as.factor(cohortsurvival$bevflag)
cohortsurvival$bevflag<- relevel(cohortsurvival$bevflag, ref = "1")
cohortsurvival$ETHNICITY2<- relevel(cohortsurvival$ETHNICITY2, ref = "White")
cohortsurvival$ethnicitygroup<-as.factor(cohortsurvival$ethnicitygroup)

cohortsurvival$ethnicitygroup<- relevel(cohortsurvival$ethnicitygroup, ref = "White")

cohortsurvival %>% 
  ungroup() %>% 
  skimr::skim()

survival<-coxph(Surv(overall_survival, EVENT) ~adjuvantbreakcategory+ modality+ Region+ CENTRE_TYPE+ethnicitygroup+BMI2+IMD2015_1+ AGECATEGORY+bevflag+STAGE_BEST_CLEAN+PS,data=cohortsurvival)
summary(survival)

coxtable<-tbl_regression(survival, exponentiate = TRUE)%>% 
  add_n() #Gtsummary table for Cox regression analysis
coxtable %>% 
  add_n() %>% 
  as_gt() %>% 
  gt::gtsave("cox_adjuvant_time_category.docx")
```

Cox regression for adjuvant time as a continuous variable:
```{r}
survival2<-coxph(Surv(overall_survival, EVENT) ~adjuvantbreak+ modality+ Region+ CENTRE_TYPE+ethnicitygroup+BMI2+IMD2015_1+ AGECATEGORY+bevflag+STAGE_BEST_CLEAN+PS,data=cohortsurvival)
summary(survival2)

coxtable2<-tbl_regression(survival2, exponentiate = TRUE)%>% 
  add_n() #Gtsummary table for Cox regression analysis
coxtable2 %>% 
  add_n() %>% 
  as_gt() %>% 
  gt::gtsave("cox_adjuvant_time_continuous.docx")
```


KM curve for PDS only:
KM curve comparing 5-year OS by adjuvant period:
```{r}
pds_analysis<-cohortsurvival %>% 
  filter(modality=="PDS")
pds_analysis<-pds_analysis %>% 
  mutate(overall_survival=overall_survival/365.25)

kmcurvePDS<-survfit(Surv(overall_survival, EVENT)~adjuvantbreakcategory, pds_analysis)

summary(kmcurvePDS)

kmcurveplot_PDS<-ggsurvplot(kmcurvePDS,
           pval=F,
           conf.int=TRUE,
           conf.int.style="step",
           xlab="Time in years",
           xlim=c(0,5),
           break.time.by=1,
           ggtheme=theme_minimal(),
           risk.table="absolute",
           risk.table.title="Number at risk",
           risk.table.height=0.3,
           risk.table.y.text.col=T,
           risk.table.y.text=T,
           ncensor.plot=TRUE,srv.median.line="hv",
           legend.labs=c("<=6 weeks","6< weeks"))

kmcurveplot_PDS
```

KM curve for IDS only:
KM curve comparing 5-year OS by adjuvant period:
```{r}
ids_analysis<-cohortsurvival %>% 
  filter(modality=="IDS")

ids_analysis<-ids_analysis %>% 
  mutate(overall_survival=overall_survival/365.25)

kmcurveIDS<-survfit(Surv(overall_survival, EVENT)~adjuvantbreakcategory, ids_analysis)

summary(kmcurveIDS)

kmcurveplot_IDS<-ggsurvplot(kmcurveIDS,
           pval=F,
           conf.int=TRUE,
           conf.int.style="step",
           xlab="Time in years",
           xlim=c(0,5),
           break.time.by=1,
           ggtheme=theme_minimal(),
           risk.table="absolute",
           risk.table.title="Number at risk",
           risk.table.height=0.3,
           risk.table.y.text.col=T,
           risk.table.y.text=T,
           ncensor.plot=TRUE,srv.median.line="hv",
            legend.labs=c("<=6 weeks","6< weeks"))
kmcurveplot_IDS
```
Cut PS into 0,1,>1 for Cox
Cox regression: 5 year OS for PDS only
```{r}
survival_PDS<-coxph(Surv(overall_survival, EVENT) ~adjuvantbreakcategory+STAGE_BEST_CLEAN+ AGECATEGORY +BMI2+bevflag+Region+ CENTRE_TYPE+ETHNICITY2+IMD2015_1+PS,data=pds_analysis)
summary(survival_PDS)

coxtable_PDS_only<-tbl_regression(survival_PDS, exponentiate = TRUE)%>% 
  add_n() #Gtsummary table for Cox regression analysis
coxtable_PDS_only 





coxtable_PDS_only%>% 
  as_gt() %>% 
  gt::gtsave("cox_regression_PDS_only.docx")
```

Cox regression: 5 year OS for IDS only
```{r}
survival_IDS<-coxph(Surv(overall_survival, EVENT) ~adjuvantbreakcategory+STAGE_BEST_CLEAN+ AGECATEGORY +BMI2+bevflag+Region+ CENTRE_TYPE+ethnicitygroup+IMD2015_1+PS,data=ids_analysis)
summary(survival_IDS)

coxtable_IDS_only<-tbl_regression(survival_IDS, exponentiate = TRUE)%>% 
  add_n() #Gtsummary table for Cox regression analysis
coxtable_IDS_only 

coxtable_IDS_only%>%
  as_gt() %>% 
  gt::gtsave("cox_regression_IDS_only.docx")
```

Complete case analysis using only patients with a complete PS from the NCRD/SACT dataset:
```{r}
completecase %>% 
  count(PSEUDO_PAT) #n=3,753

completecase$ethnicitygroup<-as.factor(completecase$ethnicitygroup)
completecase$ethnicitygroup<- relevel(completecase$ethnicitygroup, ref = "White")
```


Complete-case analysis Cox regression: 5 year OS for PDS only
```{r}
complete_case_pds_analysis<-completecase %>% 
  filter(modality=="PDS")



complete_case_pds_analysis$BMI2<- relevel(complete_case_pds_analysis$BMI2,ref = "[18.5,25)")
complete_case_pds_analysis$`Commissioning region`<-as.factor(complete_case_pds_analysis$`Commissioning region`)
complete_case_pds_analysis$`Commissioning region`<- relevel(complete_case_pds_analysis$`Commissioning region`,ref = "LONDON COMMISSIONING REGION")



survival_PDS<-coxph(Surv(overall_survival, EVENT) ~adjuvantbreakcategory+STAGE_BEST_CLEAN+PS+ AGECATEGORY +BMI2+bevflag+	
`Commissioning region`+ CENTRE_TYPE+ethnicitygroup+IMD2015_1+PS,data=complete_case_pds_analysis)
summary(survival_PDS)

coxtable_PDS_only<-tbl_regression(survival_PDS, exponentiate = TRUE)%>% 
  add_n() #Gtsummary table for Cox regression analysis
coxtable_PDS_only 

coxtable_PDS_only

coxtable_PDS_only%>%
  as_gt() %>% 
  gt::gtsave("complete_case_cox_regression_PDS_only.docx")
```

Check results are similar in complete-case analysis without including PS in the model:

```{r}
coxph(Surv(overall_survival, EVENT) ~adjuvantbreakcategory+STAGE_BEST_CLEAN+ AGECATEGORY +BMI2+bevflag+	
`Commissioning region`+ CENTRE_TYPE+ethnicitygroup+IMD2015_1+PS,data=complete_case_pds_analysis)
summary(survival_PDS)

#adjuvantbreakcategory [43,181), HR 1.0405   LCI- 0.89, HCI -  1.21)
```

Complete-case analysis Cox regression: 5 year OS for IDS only
```{r}
complete_case_ids_analysis<-completecase %>% 
  filter(modality=="IDS")

complete_case_ids_analysis$BMI2<- relevel(complete_case_ids_analysis$BMI2,ref = "[18.5,25)")
complete_case_ids_analysis$`Commissioning region`<-as.factor(complete_case_ids_analysis$`Commissioning region`)
complete_case_ids_analysis$`Commissioning region`<- relevel(complete_case_ids_analysis$`Commissioning region`,ref = "LONDON COMMISSIONING REGION")
 
survival_IDS<-coxph(Surv(overall_survival, EVENT) ~adjuvantbreakcategory+STAGE_BEST_CLEAN+PS+ AGECATEGORY +BMI2+bevflag+	
`Commissioning region`+ CENTRE_TYPE+ethnicitygroup+IMD2015_1+PS,data=complete_case_ids_analysis)
summary(survival_IDS)

coxtable_IDS_only<-tbl_regression(survival_IDS, exponentiate = TRUE)%>% 
  add_n() #Gtsummary table for Cox regression analysis
coxtable_IDS_only 

coxtable_IDS_only%>%
  as_gt() %>% 
  gt::gtsave("complete_case_cox_regression_IDS_only.docx")
```

Check results are consistent in complete-case without PS:
```{r}
check_IDS<-
  coxph(Surv(overall_survival, EVENT) ~adjuvantbreakcategory+STAGE_BEST_CLEAN+AGECATEGORY +BMI2+bevflag+`Commissioning region`+ CENTRE_TYPE+ethnicitygroup+IMD2015_1+PS,data=complete_case_ids_analysis)
summary(check_IDS)


  tbl_regression(check_IDS, exponentiate = TRUE) %>% 
  as_gt() %>% 
  gt::gtsave("complete_case_IDS_PS_excluded.docx")

#HR 1.18 (1.04-1.36)
```
Check results are consistent in complete-case without PS:
```{r}
check_PDS<-
  coxph(Surv(overall_survival, EVENT) ~adjuvantbreakcategory+STAGE_BEST_CLEAN+AGECATEGORY +BMI2+bevflag+`Commissioning region`+ CENTRE_TYPE+ethnicitygroup+IMD2015_1,data=complete_case_pds_analysis)

  tbl_regression(check_PDS, exponentiate = TRUE) %>% 
  as_gt() %>% 
  gt::gtsave("complete_case_PDS_PS_excluded.docx")

#HR 0.97 (0.82-1.18)
```
 
Histograms of adjuvant time by strata:
```{r}
graphs<-cohort %>% 
  mutate(AGECATEGORY=ifelse(AGECATEGORY=="[0,60)","<60",AGECATEGORY)) %>% 
    mutate(AGECATEGORY=ifelse(AGECATEGORY=="[60,70)","60-70",AGECATEGORY)) %>% 
  mutate(AGECATEGORY=ifelse(AGECATEGORY=="[70,150)",">70",AGECATEGORY)) 


cohort$`Commissioning region`<-factor(cohort$`Commissioning region`, levels = c("EAST OF ENGLAND COMMISSIONING REGION", "MIDLANDS COMMISSIONING REGION", "LONDON COMMISSIONING REGION","NORTH EAST & YORKSHIRE COMMISSIONING REGION","NORTH WEST COMMISSIONING REGION", "SOUTH EAST COMMISSIONING REGION", "SOUTH WEST COMMISSIONING REGION"))


cohort$AGECATEGORY<-factor(cohort$AGECATEGORY, levels = c("<60", "60-70", "<70"))


hist_by_region<-
 ggplot(cohort, aes(x = adjuvantbreak, fill = `Commissioning region`, colour = `Commissioning region`)) + theme_minimal()+
  geom_histogram(alpha = 0.5, position = "dodge") 

ggscatter(cohort, x="Commissioning region",y="adjuvantbreak", fill="Commissioning region",
          color="black", shape = 21, size=2,
          add="reg.line",
          add.params = list(color="blue", fill = "lightgray"),
         # conf.int=TRUE,
          #cor.coef=TRUE
)


ggplot(graphs, aes(y=`Commissioning region`,x=adjuvantbreak, fill =`Commissioning region` ))+geom_boxplot(show.legend = FALSE)+scale_fill_brewer(palette="Dark2")+theme_minimal()+xlab("Time to adjuvant chemotherapy (days)")+ylab(" ")

ggplot(graphs, aes(y=AGECATEGORY,x=adjuvantbreak, fill =AGECATEGORY ))+geom_boxplot(show.legend = FALSE)+scale_fill_brewer(palette="Dark2")+theme_minimal()+xlab("Time to adjuvant chemotherapy (days)")+ylab("Age category")


ggplot(graphs, aes(y=IMD2015_1,x=adjuvantbreak, fill =IMD2015_1 ))+geom_boxplot(show.legend = FALSE)+scale_fill_brewer(palette="Dark2")+theme_minimal()+xlab("Time to adjuvant chemotherapy (days)")+ylab(" ")

ggplot(graphs, aes(y=modality,x=adjuvantbreak, fill =modality ))+geom_boxplot(show.legend = FALSE)+scale_fill_brewer(palette="Dark2")+theme_minimal()+xlab("Time to adjuvant chemotherapy (days)")+ylab(" ")
```


